/**************************************************
 * CONFIG
 **************************************************/
const SHEET_ID = "10S5UM7VcFgNwN6Q6nZw4PCAvRBIyscAX667X6HTzcC8";
const SUIVI_SHEET = "suivi_colis-leman_cours";
const HISTORY_SHEET = "historique_statuts";

/**************************************************
 * API SUIVI CLIENT
 * URL : /exec?id=LC-2026-000123
 **************************************************/
function doGet(e) {
  try {
    if (!e || !e.parameter || !e.parameter.id) {
      return jsonOut({ error: "ID manquant" });
    }

    const id = String(e.parameter.id).trim();
    const sh = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SUIVI_SHEET);
    const data = sh.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim() === id) {

        return jsonOut({
          id: data[i][0],
          client: data[i][2],
          service: data[i][5],
          depart: data[i][6],
          arrivee: data[i][7],
          km: toNumber(data[i][8]),
          duree: data[i][9],
          statut: data[i][10],
          etape: data[i][11],
          updated: formatDate(data[i][1]),
          prixTTC: formatPrice(data[i][12]),
          history: getHistory(id)
        });
      }
    }

    return jsonOut({ error: "NumÃ©ro de suivi inconnu" });

  } catch (err) {
    return jsonOut({ error: err.message });
  }
}

/**************************************************
 * HISTORIQUE
 **************************************************/
function getHistory(id){
  const sh = SpreadsheetApp
    .openById(SHEET_ID)
    .getSheetByName(HISTORY_SHEET);

  const data = sh.getDataRange().getValues();
  const out = [];

  for(let i=1;i<data.length;i++){
    if(String(data[i][0]).trim() === id){
      out.push({
        date: formatDate(data[i][1]),
        statut: data[i][2],
        comment: data[i][3]
      });
    }
  }

  return out;
}

/**************************************************
 * UTILS
 **************************************************/
function jsonOut(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function toNumber(v) {
  if (!v) return "";
  const n = Number(String(v).replace(",", "."));
  return isNaN(n) ? "" : n;
}

function formatPrice(v) {
  if (!v) return "";
  return String(v).replace("CHF","").replace(",",".").trim();
}

function formatDate(d){
  if (!d) return "";
  const date = new Date(d);
  return Utilities.formatDate(date, "Europe/Zurich", "dd.MM.yyyy HH:mm");
}
