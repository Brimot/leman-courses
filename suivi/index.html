<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Estimation ‚Äì L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:linear-gradient(135deg,#0B2A44,#123B5A);
  margin:0;
  padding:30px;
}
.card{
  max-width:980px;
  margin:auto;
  background:#fff;
  padding:25px;
  border-radius:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.3);
}
h2{text-align:center;color:#0B2A44;margin:0}
.sub{text-align:center;color:#38556e;margin-top:4px}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
  box-sizing:border-box;
}
button{
  background:#FDB913;
  font-weight:bold;
  border:none;
  cursor:pointer;
}
button:hover{opacity:.92}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media(max-width:820px){.grid-2,.grid-3{grid-template-columns:1fr}}
#map{width:100%;height:280px;margin-top:12px;border-radius:12px;border:1px solid #ddd}
.badge{background:#0B2A44;color:#fff;padding:8px 14px;border-radius:999px}
.badges{display:flex;justify-content:center;gap:10px;margin-top:12px;flex-wrap:wrap}
.pricegrid{display:grid;grid-template-columns:1fr 1fr 1fr;text-align:center;gap:10px;margin-top:10px}
.big{font-size:22px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f5f7fa;color:#0B2A44}
.smallbtn{
  background:#e6eef8;
  border:1px solid #cfd9e6;
  border-radius:8px;
  padding:8px;
  cursor:pointer;
}
.note{font-size:12px;color:#567;text-align:center;margin-top:10px}
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1XwMisUcFm6UwQseU1sUU-n_55uI9AWQ&callback=initMap" async defer></script>
</head>

<body>

<form id="formDemande"
action="https://script.google.com/macros/s/AKfycbxyrSTQETLmwE94AQWwQ3HZ82dOOssy4a72CxBIFS9pdSjWFOMapogQG2j61FPHkdn1/exec"
method="POST"
target="_blank">

<div class="card">

<h2>üöö Estimation L√©man Courses</h2>
<p class="sub">Google Maps ¬∑ TVA 8.1% ¬∑ Min 25 CHF</p>

<div class="grid-3">
  <input name="client" placeholder="Nom" required>
  <input name="tel" placeholder="T√©l√©phone">
  <input name="email" placeholder="E-mail" required>
</div>

<h3>üìç Prise en charge</h3>
<div class="grid-2">
  <input id="pc_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'pc_ville')">
  <input id="pc_ville" placeholder="Ville">
  <input id="pc_rue" placeholder="Rue">
  <input id="pc_no" placeholder="N¬∞">
</div>

<h3>üöö Livraison</h3>
<div class="grid-2">
  <input id="lv_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'lv_ville')">
  <input id="lv_ville" placeholder="Ville">
  <input id="lv_rue" placeholder="Rue">
  <input id="lv_no" placeholder="N¬∞">
</div>

<button type="button" onclick="calculerDistance()">Calculer distance</button>
<div id="map"></div>

<div class="badges">
  <div class="badge">Distance: <span id="distance_txt">‚Äì</span> km</div>
  <div class="badge">Dur√©e: <span id="duree_txt">‚Äì</span> min</div>
</div>

<select id="service" name="service" onchange="recalculer()">
  <option value="">Type de livraison</option>
  <option value="urgent">Urgente</option>
  <option value="express">Express</option>
  <option value="eco">Eco</option>
</select>

<h3>üì¶ Colis (max 5)</h3>
<table>
<thead>
<tr>
  <th>#</th>
  <th>Poids (kg)</th>
  <th>Dimensions (cm)</th>
  <th></th>
</tr>
</thead>
<tbody id="colis_table"></tbody>
</table>
<button type="button" class="smallbtn" onclick="ajouterColis()">+ Ajouter colis</button>

<div class="pricegrid">
  <div>HT<br><span class="big">CHF <span id="prix_ht">‚Äì</span></span></div>
  <div>TVA<br><span class="big">CHF <span id="prix_tva">‚Äì</span></span></div>
  <div><strong>TTC</strong><br><span class="big">CHF <span id="prix_ttc">‚Äì</span></span></div>
</div>

<p class="note">
+5 CHF d√®s le 2e colis ¬∑ 15‚Äì25kg +2 CHF/kg ¬∑ &gt;25kg +5 CHF/kg
</p>

<!-- Champs cach√©s -->
<input type="hidden" name="depart" id="f_depart">
<input type="hidden" name="arrivee" id="f_arrivee">
<input type="hidden" name="km" id="f_km">
<input type="hidden" name="duree" id="f_duree">
<input type="hidden" name="prix_ht" id="f_prix_ht">
<input type="hidden" name="prix_tva" id="f_prix_tva">
<input type="hidden" name="prix_ttc" id="f_prix_ttc">
<input type="hidden" name="colis_json" id="f_colis_json">

<button type="submit" onclick="return avantEnvoi()">Envoyer</button>

</div>
</form>

<script>
let map, ds, dr, km=0, duree=0;
let colis=[];

const TVA=0.081;
const PRIX_KM=1.20;
const PRIX_MIN=25;
const SUPPL_COLIS=5;
const MAX_COLIS=5;

const MULTI_SERVICE={urgent:1.25,express:1.10,eco:0.90};

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:{lat:46.8,lng:8.3},zoom:7});
  ds=new google.maps.DirectionsService();
  dr=new google.maps.DirectionsRenderer({map});
}

function autoVilleGoogle(npa,villeId){
  npa=String(npa||"").replace(/\D/g,"");
  if(npa.length!==4) return;
  new google.maps.Geocoder().geocode(
    {address:npa,componentRestrictions:{country:"CH"}},
    (res,status)=>{
      if(status==="OK"&&res[0]){
        let v="";
        res[0].address_components.forEach(c=>{
          if(c.types.includes("locality")||c.types.includes("postal_town")) v=c.long_name;
          if(!v&&c.types.includes("administrative_area_level_3")) v=c.long_name;
        });
        if(v) document.getElementById(villeId).value=v;
      }
    }
  );
}

function adresse(p){
  const rue=document.getElementById(p+"_rue").value.trim();
  const no=document.getElementById(p+"_no").value.trim();
  const npa=document.getElementById(p+"_npa").value.trim();
  const ville=document.getElementById(p+"_ville").value.trim();
  if(!npa||!ville) return "";
  return `${rue} ${no}, ${npa} ${ville}, Suisse`.replace(/\s+/g," ").trim();
}

function calculerDistance(){
  const o=adresse("pc");
  const d=adresse("lv");
  if(!o||!d){alert("Adresse incompl√®te");return;}
  ds.route({origin:o,destination:d,travelMode:"DRIVING"},(r,s)=>{
    if(s==="OK"){
      dr.setDirections(r);
      const leg=r.routes[0].legs[0];
      km=leg.distance.value/1000;
      duree=Math.max(15,Math.ceil(leg.duration.value/60));
      distance_txt.innerText=km.toFixed(1);
      duree_txt.innerText=duree;
      recalculer();
    }
  });
}

/* COLIS */
function ajouterColis(){
  if(colis.length>=MAX_COLIS){alert("Max 5 colis");return;}
  colis.push({id:Date.now(),poids:1,L:30,l:20,h:10});
  renderColis();
  recalculer();
}

function renderColis(){
  colis_table.innerHTML="";
  colis.forEach((c,i)=>{
    colis_table.innerHTML+=`
<tr>
<td>${i+1}</td>
<td><input type="number" value="${c.poids}" oninput="majColis(${c.id},'poids',this.value)"></td>
<td>
<input style="width:50px" value="${c.L}" oninput="majColis(${c.id},'L',this.value)"> √ó
<input style="width:50px" value="${c.l}" oninput="majColis(${c.id},'l',this.value)"> √ó
<input style="width:50px" value="${c.h}" oninput="majColis(${c.id},'h',this.value)">
</td>
<td>${i?`<button onclick="supprimerColis(${c.id})">‚ùå</button>`:"‚Äî"}</td>
</tr>`;
  });
}

function majColis(id,champ,val){
  const c=colis.find(x=>x.id===id);
  if(c){c[champ]=Number(val)||0;recalculer();}
}

function supprimerColis(id){
  colis=colis.filter(c=>c.id!==id);
  renderColis();
  recalculer();
}

function surchargePoids(p){
  if(p<=15) return 0;
  if(p<=25) return (p-15)*2;
  return 20+(p-25)*5;
}

/* PRIX */
function recalculer(){
  const service=serviceEl.value;
  if(!km||!service) return;

  let ht=Math.max(PRIX_MIN,km*PRIX_KM);
  ht*=MULTI_SERVICE[service]||1;

  colis.forEach((c,i)=>{
    ht+=surchargePoids(c.poids);
    if(i>0) ht+=SUPPL_COLIS;
  });

  const tva=ht*TVA;
  const ttc=ht+tva;

  prix_ht.innerText=ht.toFixed(2);
  prix_tva.innerText=tva.toFixed(2);
  prix_ttc.innerText=ttc.toFixed(2);
}

function avantEnvoi(){
  if(!km){alert("Calcule la distance");return false;}
  if(!serviceEl.value){alert("Choisis un service");return false;}

  f_depart.value=adresse("pc");
  f_arrivee.value=adresse("lv");
  f_km.value=km.toFixed(1);
  f_duree.value=duree;
  f_prix_ht.value=prix_ht.innerText;
  f_prix_tva.value=prix_tva.innerText;
  f_prix_ttc.value=prix_ttc.innerText;
  f_colis_json.value=JSON.stringify(colis);

  return true;
}

const serviceEl=document.getElementById("service");
ajouterColis();
</script>

</body>
</html>
