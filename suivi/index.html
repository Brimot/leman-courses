<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi LÃ©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#0B2A44;padding:30px}
.card{max-width:650px;margin:auto;background:#fff;padding:25px;border-radius:14px}
input,button{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
button{background:#FDB913;border:none;font-weight:bold;cursor:pointer}
#map{height:320px;margin-top:15px;border-radius:10px}
.status{font-size:20px;font-weight:bold;margin-top:10px}
.error{color:red;font-weight:bold}
hr{margin:15px 0}
</style>
</head>

<body>

<div class="card">
<h2>ðŸ“¦ Suivi LÃ©man Courses</h2>

<input id="code" placeholder="LC-001">
<button onclick="go()">Suivre mon colis</button>

<div id="error" class="error"></div>

<div id="result"></div>
<div id="map"></div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwf-K-PpOihbiCVV5XP6n0icy9gJgiwtmptYuwVlDzcTG6LhAGggvv-9usWfM2r0zE5/exec";
let map, routeLayer;

function mapStatus(s){
  s=s.toLowerCase();
  if(s.includes("livrÃ©")) return "âœ… LivrÃ©";
  if(s.includes("livraison")) return "ðŸšš En livraison";
  return "ðŸ“¦ En cours";
}

async function go(){
  const code=document.getElementById("code").value.trim();
  const result=document.getElementById("result");
  const error=document.getElementById("error");
  result.innerHTML=""; error.innerHTML="";

  if(!code){error.textContent="Entrez un numÃ©ro de suivi.";return;}

  try{
    const r=await fetch(API+"?code="+encodeURIComponent(code));
    const d=await r.json();
    if(d.error){error.textContent=d.error;return;}

    result.innerHTML=`
      <div class="status">${mapStatus(d.statut)}</div>
      <b>${code}</b> â€” ${d.etape}
      <hr>
      <b>Client</b><br>${d.client.nom}<br>${d.client.tel}<br>${d.client.email}
      <hr>
      <b>Prise en charge</b><br>
      ${d.prise.adresse}<br>${d.prise.npa} ${d.prise.ville}<br>${d.prise.heure}
      <hr>
      <b>Livraison</b><br>
      ${d.livraison.adresse}<br>${d.livraison.npa} ${d.livraison.ville}<br>${d.livraison.heure}
    `;

    if(!d.prise.lat||!d.livraison.lat) return;

    const A=[d.prise.lat,d.prise.lng];
    const B=[d.livraison.lat,d.livraison.lng];

    if(!map){
      map=L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    }

    if(routeLayer) map.removeLayer(routeLayer);
    map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });

    // Route OSRM
    const r2=await fetch(`https://router.project-osrm.org/route/v1/driving/${A[1]},${A[0]};${B[1]},${B[0]}?overview=full&geometries=geojson`);
    const d2=await r2.json();
    routeLayer=L.geoJSON(d2.routes[0].geometry,{style:{color:"red",weight:4}}).addTo(map);

    L.marker(A).addTo(map).bindPopup("Prise en charge");
    L.marker(B).addTo(map).bindPopup("Livraison");

    map.fitBounds(routeLayer.getBounds(),{padding:[30,30]});

  }catch(e){
    error.textContent="Erreur de connexion au service.";
  }
}
</script>

</body>
</html>
