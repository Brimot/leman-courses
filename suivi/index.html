<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Estimation â€“ LÃ©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#0B2A44;margin:0;padding:30px}
.card{max-width:900px;margin:auto;background:#fff;padding:25px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{text-align:center;color:#0B2A44}
input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{background:#FDB913;color:#000;font-weight:bold;border:none;cursor:pointer}
.section{margin-top:22px;padding-top:12px;border-top:1px solid #ddd}
.label{font-weight:bold;color:#0B2A44}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
#map{width:100%;height:260px;margin-top:12px;border-radius:12px;border:1px solid #ccc}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#f5f7fa}
.smallbtn{background:#e6eef8;color:#0B2A44;border:1px solid #ccc;font-weight:bold;padding:6px;border-radius:6px}
.price{text-align:center;margin-top:15px}
</style>

<!-- Google Maps AVEC callback -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1XwMisUcFm6UwQseU1sUU-n_55uI9AWQ&callback=initMap" async defer></script>
</head>

<body>

<div class="card">
<h2>ğŸšš Estimation LÃ©man Courses</h2>

<div class="section">
  <div class="label">ğŸ‘¤ CoordonnÃ©es client</div>
  <input id="client_nom" placeholder="Nom / Entreprise">
  <input id="client_tel" placeholder="TÃ©lÃ©phone">
  <input id="client_email" placeholder="E-mail">
</div>

<div class="section">
  <div class="label">ğŸ“ Prise en charge</div>
  <div class="grid-2">
    <input id="pc_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'pc_ville')">
    <input id="pc_ville" placeholder="Ville">
    <input id="pc_rue" placeholder="Rue">
    <input id="pc_no" placeholder="NÂ°">
  </div>
</div>

<div class="section">
  <div class="label">ğŸšš Livraison</div>
  <div class="grid-2">
    <input id="lv_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'lv_ville')">
    <input id="lv_ville" placeholder="Ville">
    <input id="lv_rue" placeholder="Rue">
    <input id="lv_no" placeholder="NÂ°">
  </div>
</div>

<button onclick="calculerDistance()">Calculer la distance</button>
<div id="map"></div>

<div class="section">
  <div class="label">ğŸš€ Type de livraison</div>
  <select id="service" onchange="recalculer()">
    <option value="">â€” Choisir â€”</option>
    <option value="urgent">Urgente 4h</option>
    <option value="express">Express 12h</option>
    <option value="priority">Priority 24h</option>
    <option value="eco">Eco 48h</option>
  </select>
</div>

<div class="section">
  <div class="label">ğŸ“¦ Colis</div>
  <table>
    <thead>
      <tr><th>Colis</th><th>Poids</th><th>Dimensions</th><th>Type</th><th></th></tr>
    </thead>
    <tbody id="colis_table"></tbody>
  </table>
  <button class="smallbtn" onclick="ajouterColis()">â• Ajouter un colis</button>
</div>

<div class="price">
  Distance : <span id="distance_txt">â€“</span> km<br>
  DurÃ©e : <span id="duree_txt">â€“</span> min<br><br>
  HT : CHF <span id="prix_ht">â€“</span><br>
  TVA : CHF <span id="prix_tva">â€“</span><br>
  <strong>TTC : CHF <span id="prix_ttc">â€“</span></strong>
</div>

<button onclick="envoyer()">Envoyer la demande</button>
</div>

<script>
/* CONFIG */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCDBdKKVgfU0jnT2-tVpHQA6czHNHLdKw-Y1wP0v5Te7lWkckcVnkSyCW348zXFOTZ/exec";
const TVA = 0.081;
const BASE_65 = { urgent:65, express:50, priority:35, eco:27 };
const service = document.getElementById("service");

/* MAP */
let map, ds, dr, km = 0, duree = 0;

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), { center:{lat:46.8,lng:8.3}, zoom:7 });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({ map });
}

function autoVilleGoogle(npa, id){
  if(!/^\d{4}$/.test(npa)) return;
  new google.maps.Geocoder().geocode({address:npa,componentRestrictions:{country:"CH"}},(r,s)=>{
    if(s==="OK") r[0].address_components.forEach(c=>{
      if(c.types.includes("locality")) document.getElementById(id).value=c.long_name;
    });
  });
}

function adresse(p){
  return `${document.getElementById(p+"_rue").value} ${document.getElementById(p+"_no").value}, ${document.getElementById(p+"_npa").value} ${document.getElementById(p+"_ville").value}, Suisse`;
}

function calculerDistance(){
  ds.route({origin:adresse("pc"),destination:adresse("lv"),travelMode:"DRIVING"},(r,s)=>{
    if(s==="OK"){
      dr.setDirections(r);
      const leg=r.routes[0].legs[0];
      km=leg.distance.value/1000;
      duree=Math.max(15,Math.ceil(leg.duration.value/60));
      distance_txt.innerText=km.toFixed(1);
      duree_txt.innerText=duree;
      recalculer();
    }
  });
}

/* COLIS */
let colis=[];
function ajouterColis(){ colis.push({poids:1}); renderColis(); }
function renderColis(){
  colis_table.innerHTML="";
  colis.forEach((c,i)=>{
    colis_table.innerHTML+=`<tr>
      <td>${i+1}</td>
      <td><input type="number" value="${c.poids}" oninput="colis[${i}].poids=this.value;recalculer()"></td>
      <td>â€”</td><td>Standard</td><td></td>
    </tr>`;
  });
}
ajouterColis();

/* PRIX */
function recalculer(){
  if(!km || !service.value) return;
  let ht=BASE_65[service.value];
  colis.forEach((c,i)=>{ if(c.poids>15) ht+= (c.poids-15)*2; });
  prix_ht.innerText=ht.toFixed(2);
  prix_tva.innerText=(ht*TVA).toFixed(2);
  prix_ttc.innerText=(ht*(1+TVA)).toFixed(2);
}

/* ENVOI */
function envoyer(){
  fetch(SCRIPT_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"client="+encodeURIComponent(client_nom.value)
  });
  alert("âœ… Demande envoyÃ©e");
}
</script>

</body>
</html>

