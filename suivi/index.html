<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Estimation ‚Äì L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#0B2A44;margin:0;padding:30px}
.card{max-width:900px;margin:auto;background:#fff;padding:25px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{text-align:center;color:#0B2A44}
input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{background:#FDB913;color:#000;font-weight:bold;border:none;cursor:pointer}
.section{margin-top:22px;padding-top:12px;border-top:1px solid #ddd}
.label{font-weight:bold;color:#0B2A44}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
#map{width:100%;height:260px;margin-top:12px;border-radius:12px;border:1px solid #ccc}
.price{text-align:center;margin-top:15px}
</style>

<!-- Google Maps avec callback -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1XwMisUcFm6UwQseU1sUU-n_55uI9AWQ&callback=initMap" async defer></script>

</head>
<body>

<form action="https://script.google.com/macros/s/AKfycbzvPN6yV5wVT7mJGQgo6-YMGHlBdD_mveHTwmbFaKSpsIpbQ52gmaCk5m0zogtmKVZn/exec"
      method="POST"
      target="_blank">

<div class="card">

<h2>üöö Estimation L√©man Courses</h2>

<div class="section">
  <div class="label">üë§ Coordonn√©es client</div>
  <input name="client" id="client_nom" placeholder="Nom / Entreprise" required>
  <input name="email" id="client_email" placeholder="E-mail" required>
  <input name="tel" id="client_tel" placeholder="T√©l√©phone">
</div>

<div class="section">
  <div class="label">üìç Prise en charge</div>
  <div class="grid-2">
    <input id="pc_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'pc_ville')">
    <input id="pc_ville" name="ville_pc" placeholder="Ville">
    <input id="pc_rue" placeholder="Rue">
    <input id="pc_no" placeholder="N¬∞">
  </div>
</div>

<div class="section">
  <div class="label">üöö Livraison</div>
  <div class="grid-2">
    <input id="lv_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'lv_ville')">
    <input id="lv_ville" name="ville_lv" placeholder="Ville">
    <input id="lv_rue" placeholder="Rue">
    <input id="lv_no" placeholder="N¬∞">
  </div>
</div>

<button type="button" onclick="calculerDistance()">Calculer la distance</button>

<div id="map"></div>

<div class="price">
  Distance : <span id="distance_txt">‚Äì</span> km<br>
  Dur√©e : <span id="duree_txt">‚Äì</span> min
</div>

<!-- Champs cach√©s envoy√©s au script -->
<input type="hidden" name="depart" id="f_depart">
<input type="hidden" name="arrivee" id="f_arrivee">
<input type="hidden" name="km" id="f_km">
<input type="hidden" name="duree" id="f_duree">

<button type="submit" onclick="remplirForm()">Envoyer la demande</button>

</div>
</form>

<script>
// === CONFIG MAP ===
let map, ds, dr, km = 0, duree = 0;

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:46.8,lng:8.3},
    zoom:7
  });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({ map });
}

function autoVilleGoogle(npa, villeId){
  if(!/^\d{4}$/.test(npa)) return;
  new google.maps.Geocoder().geocode({
    address:npa,
    componentRestrictions:{country:"CH"}
  }, (res, status) => {
    if(status === "OK" && res[0]){
      res[0].address_components.forEach(c => {
        if(c.types.includes("locality") || c.types.includes("postal_town")){
          document.getElementById(villeId).value = c.long_name;
        }
      });
    }
  });
}

function adresse(p){
  return `${document.getElementById(p+"_rue").value} ${document.getElementById(p+"_no").value}, ${document.getElementById(p+"_npa").value} ${document.getElementById(p+"_ville").value}, Suisse`;
}

function calculerDistance(){
  const d = adresse("pc");
  const a = adresse("lv");
  if(!d || !a){
    alert("Adresse incompl√®te");
    return;
  }

  ds.route({
    origin: d,
    destination: a,
    travelMode:"DRIVING"
  }, (r, s) => {
    if(s === "OK"){
      dr.setDirections(r);
      const leg = r.routes[0].legs[0];
      km = leg.distance.value / 1000;
      duree = Math.max(15, Math.ceil(leg.duration.value / 60));
      document.getElementById("distance_txt").innerText = km.toFixed(1);
      document.getElementById("duree_txt").innerText = duree;
    }
  });
}

function remplirForm(){
  document.getElementById("f_depart").value = adresse("pc");
  document.getElementById("f_arrivee").value = adresse("lv");
  document.getElementById("f_km").value = km;
  document.getElementById("f_duree").value = duree;
}
</script>

</body>
</html>
