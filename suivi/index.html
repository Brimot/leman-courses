<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Estimation ‚Äì L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#0B2A44;margin:0;padding:30px}
.card{max-width:900px;margin:auto;background:#fff;padding:25px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{text-align:center;color:#0B2A44}

input,select,button{
  width:100%;padding:12px;margin-top:8px;
  border-radius:8px;border:1px solid #ccc;font-size:15px
}
button{background:#FDB913;color:#000;font-weight:bold;border:none;cursor:pointer}
button:hover{opacity:.9}

.section{margin-top:22px;padding-top:12px;border-top:1px solid #ddd}
.label{font-weight:bold;color:#0B2A44;margin-top:10px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:700px){.grid-2{grid-template-columns:1fr}}

#map{width:100%;height:260px;margin-top:12px;border-radius:12px;border:1px solid #ccc}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#f5f7fa}

.smallbtn{
  background:#e6eef8;color:#0B2A44;border:1px solid #ccc;
  font-weight:bold;padding:6px;border-radius:6px
}

.price{font-size:18px;text-align:center;margin-top:15px}
.price strong{font-size:22px}
.note{font-size:13px;color:#555;text-align:center}
</style>

<!-- Google Maps + Geocoding -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1XwMisUcFm6UwQseU1sUU-n_55uI9AWQ""></script>
</head>

<body>

<div class="card">
<h2>üöö Estimation L√©man Courses</h2>

<div class="section">
  <div class="label">üë§ Coordonn√©es client</div>
  <input id="client_nom" placeholder="Nom / Entreprise">
  <input id="client_tel" placeholder="T√©l√©phone">
  <input id="client_email" placeholder="E-mail">
</div>

<div class="section">
  <div class="label">üìç Prise en charge</div>
  <div class="grid-2">
    <input id="pc_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'pc_ville')">
    <input id="pc_ville" placeholder="Ville">
    <input id="pc_rue" placeholder="Rue">
    <input id="pc_no" placeholder="N¬∞">
  </div>
</div>

<div class="section">
  <div class="label">üöö Livraison</div>
  <div class="grid-2">
    <input id="lv_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'lv_ville')">
    <input id="lv_ville" placeholder="Ville">
    <input id="lv_rue" placeholder="Rue">
    <input id="lv_no" placeholder="N¬∞">
  </div>
</div>

<button onclick="calculerDistance()">Calculer la distance</button>
<div id="map"></div>

<div class="section">
  <div class="label">üöÄ Type de livraison</div>
  <select id="service" onchange="recalculer()">
    <option value="">‚Äî Choisir ‚Äî</option>
    <option value="urgent">Urgente 4h</option>
    <option value="express">Express 12h</option>
    <option value="priority">Priority 24h</option>
    <option value="eco">Eco 48h</option>
  </select>
</div>

<div class="section">
  <div class="label">üì¶ Colis (max 5 ‚Äì m√™me destination)</div>
  <table>
    <thead>
      <tr>
        <th>Colis</th>
        <th>Poids (kg)</th>
        <th>Dimensions (cm)</th>
        <th>Type</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="colis_table"></tbody>
  </table>
  <button class="smallbtn" type="button" onclick="ajouterColis()">‚ûï Ajouter un colis (+5 CHF)</button>
</div>

<div class="price">
  Distance : <span id="distance_txt">‚Äì</span> km<br>
  Dur√©e : <span id="duree_txt">‚Äì</span> min<br><br>
  HT : CHF <span id="prix_ht">‚Äì</span><br>
  TVA 8.1 % : CHF <span id="prix_tva">‚Äì</span><br>
  <strong>TTC : CHF <span id="prix_ttc">‚Äì</span></strong>
</div>

<div class="note">Prix indicatif ‚Äì confirm√© apr√®s validation</div>

<button onclick="envoyer()">Envoyer la demande</button>
</div>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCDBdKKVgfU0jnT2-tVpHQA6czHNHLdKw-Y1wP0v5Te7lWkckcVnkSyCW348zXFOTZ/exec";
const TVA = 0.081;
const MAX_COLIS = 5;
const BASE_65 = { urgent:65, express:50, priority:35, eco:27 };
const SECOND_COLIS = 5;

/* ===== MAP ===== */
let map, ds, dr, km=0, duree=0;
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:{lat:46.8,lng:8.3},zoom:7});
  ds=new google.maps.DirectionsService();
  dr=new google.maps.DirectionsRenderer({map});
}
window.onload=initMap;

function autoVilleGoogle(npa, villeId){
  if(!/^\d{4}$/.test(npa)) return;
  const geocoder=new google.maps.Geocoder();
  geocoder.geocode({address:npa,componentRestrictions:{country:"CH"}},(res,status)=>{
    if(status==="OK" && res[0]){
      const c=res[0].address_components;
      let v="";
      c.forEach(x=>{
        if(x.types.includes("locality")||x.types.includes("postal_town")) v=x.long_name;
      });
      if(v) document.getElementById(villeId).value=v;
    }
  });
}

function adresse(p){
  const npa=document.getElementById(p+"_npa").value;
  const ville=document.getElementById(p+"_ville").value;
  const rue=document.getElementById(p+"_rue").value;
  const no=document.getElementById(p+"_no").value;
  if(!npa||!ville) return null;
  return `${rue} ${no}, ${npa} ${ville}, Suisse`;
}

function calculerDistance(){
  const d=adresse("pc"), a=adresse("lv");
  if(!d||!a){alert("Adresse incompl√®te");return;}
  ds.route({origin:d,destination:a,travelMode:"DRIVING"},(r,s)=>{
    if(s==="OK"){
      dr.setDirections(r);
      const leg=r.routes[0].legs[0];
      km=leg.distance.value/1000;
      duree=Math.max(15,Math.ceil(leg.duration.value/60));
      distance_txt.innerText=km.toFixed(1);
      duree_txt.innerText=duree;
      recalculer();
    }
  });
}

/* ===== COLIS ===== */
let colis=[];
function ajouterColis(){
  if(colis.length>=MAX_COLIS){alert("Maximum 5 colis");return;}
  colis.push({id:Date.now(),poids:1,L:30,l:20,h:10,type:"Colis standard"});
  renderColis();recalculer();
}
function supprimerColis(id){
  colis=colis.filter(c=>c.id!==id);
  renderColis();recalculer();
}
function maj(id,f,v){
  const c=colis.find(c=>c.id===id);
  if(c){c[f]=v;recalculer();}
}
function renderColis(){
  colis_table.innerHTML="";
  colis.forEach((c,i)=>{
    colis_table.innerHTML+=`
<tr>
<td>Colis ${i+1}</td>
<td><input type="number" value="${c.poids}" oninput="maj(${c.id},'poids',this.value)"></td>
<td>
<input style="width:40px" value="${c.L}" oninput="maj(${c.id},'L',this.value)">√ó
<input style="width:40px" value="${c.l}" oninput="maj(${c.id},'l',this.value)">√ó
<input style="width:40px" value="${c.h}" oninput="maj(${c.id},'h',this.value)">
</td>
<td>
<select onchange="maj(${c.id},'type',this.value)">
<option>Documents</option><option selected>Colis standard</option>
<option>Mat√©riel m√©dical</option><option>Alimentaire</option>
<option>Fragile</option><option>Autre</option>
</select>
</td>
<td>${i?`<button class="smallbtn" onclick="supprimerColis(${c.id})">‚ùå</button>`:"‚Äî"}</td>
</tr>`;
  });
}
ajouterColis();

/* ===== PRIX ===== */
function surchargePoids(p){
  if(p<=15) return 0;
  if(p<=25) return (p-15)*2;
  return 20+(p-25)*5;
}
function recalculer(){
  if(!service.value||!km||!colis.length) return;
  let ht=BASE_65[service.value];
  colis.forEach((c,i)=>{
    ht+=surchargePoids(c.poids);
    if(i>0) ht+=SECOND_COLIS;
  });
  const tva=ht*TVA;
  prix_ht.innerText=ht.toFixed(2);
  prix_tva.innerText=tva.toFixed(2);
  prix_ttc.innerText=(ht+tva).toFixed(2);
}

function envoyer() {

  const data = {
    client: document.getElementById("client_nom").value,
    tel: document.getElementById("client_tel").value,
    email: document.getElementById("client_email").value,
    depart: adresse("pc"),
    arrivee: adresse("lv"),
    km: km,
    duree: duree,
    service: service.value,
    colis: colis,
    prixHT: prix_ht.innerText,
    tva: prix_tva.innerText,
    prixTTC: prix_ttc.innerText
  };

  fetch("https://script.google.com/macros/s/AKfycbwCDBdKKVgfU0jnT2-tVpHQA6czHNHLdKw-Y1wP0v5Te7lWkckcVnkSyCW348zXFOTZ/exec", {
    method: "POST",
    mode: "no-cors",   // ‚ö†Ô∏è CRUCIAL
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(data)
  });

  alert("‚úÖ Demande envoy√©e");
}

</script>

</body>
</html>
