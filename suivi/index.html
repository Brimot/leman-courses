<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#0B2A44;margin:0;padding:30px}
.card{max-width:700px;margin:auto;background:#fff;padding:25px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{text-align:center;color:#0B2A44}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:10px;border:1px solid #ccc;font-size:16px}
button{background:#FDB913;color:#000;font-weight:bold;border:none;cursor:pointer}
button:hover{opacity:.9}
.section{margin-top:20px;padding-top:10px;border-top:1px solid #ddd}
.label{font-weight:bold;color:#0B2A44}
#error{color:red;font-weight:bold;text-align:center;margin-top:15px}

#mapPopup{
 position:fixed;inset:0;background:#000000cc;display:none;z-index:9999
}
#mapHeader{
 background:#fff;padding:15px;font-weight:bold;cursor:pointer
}
#map{width:100%;height:100%}
</style>
</head>

<body>
<div class="card">
<h2>üì¶ Suivi L√©man Courses</h2>

<input id="code" placeholder="LC-001">
<button onclick="rechercher()">Suivre mon colis</button>

<div id="error"></div>

<div id="resultat" style="display:none">
  <div class="section">
    <div class="label">Statut</div>
    <div id="statut"></div>
    <div id="etape"></div>
    <div id="date"></div>
  </div>

  <div class="section">
    <div class="label">Client</div>
    <div id="client"></div>
  </div>

  <div class="section">
    <div class="label">üìç Prise en charge</div>
    <div id="prise"></div>
  </div>

  <div class="section">
    <div class="label">üöö Livraison</div>
    <div id="livraison"></div>
  </div>

  <button onclick="openMap()">Voir le trajet</button>
</div>
</div>

<!-- MAP POPUP -->
<div id="mapPopup">
  <div id="mapHeader" onclick="closeMap()">‚Üê Retour</div>
  <div id="map"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyOpxUr2KEG5jPSYW7_Q_RiHprJMQ1ardULJ67FTXpYYq5wT1sYDldemaPnXwTuwlXo/exec";

let prisePos, livPos, map, route;

async function rechercher(){
  const code = document.getElementById("code").value.trim();
  const err = document.getElementById("error");
  const res = document.getElementById("resultat");

  err.textContent="";
  res.style.display="none";

  if(!code){err.textContent="Veuillez entrer un code";return;}

  try{
    const r = await fetch(API+"?code="+encodeURIComponent(code));
    const d = await r.json();

    if(d.error){err.textContent=d.error;return;}

    document.getElementById("statut").textContent = d.statut;
    document.getElementById("etape").textContent = d.etape;
    document.getElementById("date").textContent = new Date(d.date).toLocaleString();

    document.getElementById("client").innerHTML =
      `${d.client.nom}<br>${d.client.tel}<br>${d.client.email}`;

    document.getElementById("prise").innerHTML =
      `${d.prise.adresse}<br>${d.prise.npa} ${d.prise.ville}<br>${new Date(d.prise.heure).toLocaleTimeString()}`;

    document.getElementById("livraison").innerHTML =
      `${d.livraison.adresse}<br>${d.livraison.npa} ${d.livraison.ville}<br>${new Date(d.livraison.heure).toLocaleTimeString()}`;

    prisePos=[d.prise.lat,d.prise.lng];
    livPos=[d.livraison.lat,d.livraison.lng];

    res.style.display="block";
  }
  catch(e){
    err.textContent="Erreur de connexion au service";
  }
}

async function openMap(){
  document.getElementById("mapPopup").style.display="block";

  setTimeout(async ()=>{
    if(!map){
      map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    }

    if(route) map.removeLayer(route);

    const A = [prisePos[0], prisePos[1]];
    const B = [livPos[0], livPos[1]];

    try{
      const r = await fetch(
        "https://api.allorigins.win/raw?url=" +
        encodeURIComponent(
          `https://router.project-osrm.org/route/v1/driving/${A[1]},${A[0]};${B[1]},${B[0]}?overview=full&geometries=geojson`
        )
      );

      const d = await r.json();

      route = L.geoJSON(d.routes[0].geometry, {
        style: { color: "red", weight: 4 }
      }).addTo(map);

      L.marker(A).addTo(map).bindPopup("Prise en charge");
      L.marker(B).addTo(map).bindPopup("Livraison");

      map.fitBounds(route.getBounds(), { padding:[40,40] });

    }catch(e){
      alert("Impossible de calculer le trajet");
    }

  }, 200);
}



function closeMap(){
  document.getElementById("mapPopup").style.display="none";
}
</script>

</body>
</html>
