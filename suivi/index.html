<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Estimation ‚Äì L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#0B2A44,#123B5A);
    margin:0; padding:30px;
  }
  .card{
    max-width:980px; margin:auto;
    background:#fff; padding:25px;
    border-radius:18px;
    box-shadow:0 15px 40px rgba(0,0,0,.3);
  }
  h2{ text-align:center; color:#0B2A44; margin:0; }
  .sub{ text-align:center; color:#38556e; margin:6px 0 18px; }

  input, select, button{
    width:100%;
    padding:12px;
    margin-top:8px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    box-sizing:border-box;
  }
  button{
    background:#FDB913;
    font-weight:bold;
    border:none;
    cursor:pointer;
  }
  button:hover{ opacity:.92; }

  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  @media(max-width:820px){
    .grid-2,.grid-3{ grid-template-columns:1fr; }
  }

  .section{ margin-top:18px; }
  .label{ font-weight:bold; color:#0B2A44; margin-bottom:6px; }

  #map{
    width:100%;
    height:280px;
    margin-top:12px;
    border-radius:12px;
    border:1px solid #ddd;
  }

  .badges{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .badge{
    background:#0B2A44;
    color:#fff;
    padding:8px 14px;
    border-radius:999px;
    font-size:14px;
  }

  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border:1px solid #ddd; padding:8px; text-align:center; }
  th{ background:#f5f7fa; color:#0B2A44; }

  .smallbtn{
    background:#e6eef8;
    border:1px solid #cfd9e6;
    border-radius:10px;
    padding:10px;
    cursor:pointer;
    font-weight:bold;
  }

  .pricegrid{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
    text-align:center;
    margin-top:14px;
  }
  @media(max-width:820px){ .pricegrid{ grid-template-columns:1fr; } }
  .big{ font-size:22px; font-weight:bold; }

  .note{ font-size:12px; color:#567; text-align:center; margin-top:10px; }

  /* Popup */
  #popup{
    display:none;
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:white;
    padding:22px 26px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
    text-align:center;
    z-index:9999;
  }

  /* WhatsApp floating */
  .whatsapp{
    position:fixed;
    bottom:20px;
    right:20px;
    background:#25D366;
    color:#fff;
    padding:14px 18px;
    border-radius:999px;
    font-weight:bold;
    text-decoration:none;
    box-shadow:0 6px 14px rgba(0,0,0,.3);
    z-index:9999;
  }
</style>

<!-- ‚úÖ IMPORTANT: callback=initMap -->
<script src="https://script.google.com/macros/s/AKfycbzp1rNaKsxVuff4qDqBz7QGzPqRxa0Bw2gKpTHub134WTulqrd6sFerTSotNHZwXhMT/exec" async defer></script>



</head>

<body>

<form id="formDemande" onsubmit="return envoyerFormulaire();">
  <div class="card">
    <h2>üöö Estimation L√©man Courses</h2>
    <div class="sub">Calcul Google Maps ¬∑ TVA 8.1% ¬∑ Poids max 30 kg/colis</div>

    <div class="section">
      <div class="label">üë§ Coordonn√©es</div>
      <div class="grid-3">
        <input name="client" id="client" placeholder="Nom / Entreprise" required>
        <input name="tel" id="tel" placeholder="T√©l√©phone">
        <input name="email" id="email" placeholder="E-mail" required>
      </div>
    </div>

    <div class="section">
      <div class="label">üìç Prise en charge</div>
      <div class="grid-2">
        <input id="pc_rue" placeholder="Rue">
        <input id="pc_no" placeholder="N¬∞">
        <input id="pc_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'pc_ville')">
        <input id="pc_ville" placeholder="Ville">
      </div>
    </div>

    <div class="section">
      <div class="label">üöö Livraison</div>
      <div class="grid-2">
        <input id="lv_rue" placeholder="Rue">
        <input id="lv_no" placeholder="N¬∞">
        <input id="lv_npa" placeholder="NPA" oninput="autoVilleGoogle(this.value,'lv_ville')">
        <input id="lv_ville" placeholder="Ville">
      </div>
    </div>

    <button type="button" onclick="calculerDistance()">Calculer la distance</button>

            <span id="distance_txt">‚Äì</span>
            <span id="duree_txt">‚Äì</span>
  
     

    <div class="badges">
      <div class="badge">Distance: <strong><span id="distance_txt">‚Äì</span> km</strong></div>
      <div class="badge">Dur√©e: <strong><span id="duree_txt">‚Äì</span> min</strong></div>
    </div>

    <div class="section">
      <div class="label">üöÄ Type de livraison</div>
      <select id="service" name="service" onchange="recalculer()">
        <option value="">‚Äî Choisir ‚Äî</option>
        <option value="eco">Eco 24h</option>
        <option value="express">Express 12h</option>
        <option value="urgent">Urgent 4h</option>
      </select>
    </div>

    <div class="section">
      <div class="label">üì¶ Colis (max 5)</div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Poids (kg)</th>
            <th>Type</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="colis_table"></tbody>
      </table>
      <button class="smallbtn" type="button" onclick="ajouterColis()">‚ûï Ajouter un colis</button>
      <div class="note">16‚Äì20 kg: +2 CHF/kg ¬∑ 21‚Äì30 kg: +4 CHF/kg ¬∑ +5 CHF d√®s le 2e colis</div>
    </div>

    <div class="section">
      <div class="label">üí∞ Prix</div>
      <div class="pricegrid">
        <div>HT<br><span class="big">CHF <span id="prix_ht">‚Äì</span></span></div>
        <div>TVA<br><span class="big">CHF <span id="prix_tva">‚Äì</span></span></div>
        <div><strong>TTC</strong><br><span class="big"><strong>CHF <span id="prix_ttc">‚Äì</span></strong></span></div>
      </div>
    </div>

    <!-- Hidden fields envoy√©s au script -->
    <input type="hidden" name="depart" id="f_depart">
    <input type="hidden" name="arrivee" id="f_arrivee">
    <input type="hidden" name="km" id="f_km">
    <input type="hidden" name="duree" id="f_duree">
    <input type="hidden" name="prix_ht" id="f_prix_ht">
    <input type="hidden" name="prix_tva" id="f_prix_tva">
    <input type="hidden" name="prix_ttc" id="f_prix_ttc">
    <input type="hidden" name="colis_json" id="f_colis_json">

    <button type="submit">Envoyer la demande</button>
  </div>
</form>

<div id="popup">‚úÖ Demande envoy√©e avec succ√®s<br><br>Merci, nous vous recontactons rapidement.</div>

<a class="whatsapp"
   href="https://script.google.com/macros/s/AKfycbzp1rNaKsxVuff4qDqBz7QGzPqRxa0Bw2gKpTHub134WTulqrd6sFerTSotNHZwXhMT/exec"
   target="_blank">üí¨ Aide WhatsApp</a>

<script>
/* =========================
   VARIABLES
========================= */
let map, ds, dr;
let km = 0;
let duree = 0;
let colis = [];

/* =========================
   PRIX
========================= */
const TVA = 0.081;
const PRIX_BASE = { eco: 25, express: 35, urgent: 45 };       // base fixe
const MULTI_KM  = { eco: 1.0, express: 1.2, urgent: 1.4 };    // prix / km
const SUPPL_COLIS = 5;
const MAX_COLIS = 5;

/* =========================
   MAP INIT (callback Google)
========================= */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center: {lat:46.8, lng:8.3},
    zoom: 7
  });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({ map });
}

/* =========================
   AUTO VILLE (NPA)
========================= */
function autoVilleGoogle(npa, villeId){
  npa = String(npa || "").replace(/\D/g, "");
  if(npa.length !== 4) return;
  if(!window.google || !google.maps || !google.maps.Geocoder) return;

  const geocoder = new google.maps.Geocoder();
  geocoder.geocode(
    { address: npa, componentRestrictions: { country: "CH" } },
    (res, status) => {
      if(status === "OK" && res && res[0]){
        let ville = "";
        res[0].address_components.forEach(c=>{
          if(
            c.types.includes("locality") ||
            c.types.includes("postal_town") ||
            c.types.includes("administrative_area_level_3")
          ){
            ville = c.long_name;
          }
        });
        if(ville) document.getElementById(villeId).value = ville;
      }
    }
  );
}

/* =========================
   ADRESSE COMPLETE
========================= */
function adresse(prefix){
  const rue  = document.getElementById(prefix+"_rue").value.trim();
  const no   = document.getElementById(prefix+"_no").value.trim();
  const npa  = document.getElementById(prefix+"_npa").value.trim();
  const ville= document.getElementById(prefix+"_ville").value.trim();
  if(!npa || !ville) return "";
  return `${rue} ${no}, ${npa} ${ville}, Suisse`.replace(/\s+/g," ").trim();
}

/* =========================
   CALCUL DISTANCE
========================= */
function calculerDistance(){
  const o = adresse("pc");
  const d = adresse("lv");
  if(!o || !d){ alert("Adresse incompl√®te (au minimum NPA + Ville)"); return; }
  if(!ds){ alert("Google Maps pas pr√™t. Recharge la page."); return; }

  ds.route({ origin:o, destination:d, travelMode:"DRIVING" }, (r,s)=>{
    if(s === "OK"){
      dr.setDirections(r);
      const leg = r.routes[0].legs[0];
      km = leg.distance.value / 1000;
      duree = Math.ceil(leg.duration.value / 60);
      document.getElementById("distance_txt").innerText = km.toFixed(1);
      document.getElementById("duree_txt").innerText = String(duree);
      recalculer();
    } else {
      alert("Impossible de calculer le trajet. V√©rifie les adresses.");
    }
  });
}

/* =========================
   COLIS
========================= */
function ajouterColis(){
  if(colis.length >= MAX_COLIS){ alert("Maximum 5 colis"); return; }
  colis.push({ id: Date.now(), poids: 1, type: "Standard" });
  renderColis();
  recalculer();
}

function supprimerColis(id){
  colis = colis.filter(c => c.id !== id);
  renderColis();
  recalculer();
}

function majColis(id, champ, val){
  const c = colis.find(x => x.id === id);
  if(!c) return;

  if(champ === "poids"){
    let p = Number(val) || 0;
    if(p > 30){ p = 30; }
    if(p < 1){ p = 1; }
    c.poids = p;
  } else if(champ === "type"){
    c.type = String(val || "Standard");
  }

  recalculer();
}

function renderColis(){
  const tb = document.getElementById("colis_table");
  tb.innerHTML = "";

  colis.forEach((c,i)=>{
    tb.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>
          <input type="number" min="1" max="30" value="${c.poids}"
            oninput="majColis(${c.id},'poids',this.value)">
        </td>
        <td>
          <select onchange="majColis(${c.id},'type',this.value)">
            <option ${c.type==="Standard"?"selected":""}>Standard</option>
            <option ${c.type==="M√©dical"?"selected":""}>M√©dical</option>
            <option ${c.type==="Fragile"?"selected":""}>Fragile</option>
            <option ${c.type==="Alimentaire"?"selected":""}>Alimentaire</option>
            <option ${c.type==="Documents"?"selected":""}>Documents</option>
            <option ${c.type==="Autre"?"selected":""}>Autre</option>
          </select>
        </td>
        <td>
          ${i===0 ? "‚Äî" : `<button type="button" onclick="supprimerColis(${c.id})">‚ùå</button>`}
        </td>
      </tr>
    `;
  });
}

function surchargePoids(poids){
  const p = Number(poids) || 0;
  if(p <= 15) return 0;
  if(p <= 20) return (p - 15) * 2;              // +2/kg
  if(p <= 30) return (5 * 2) + (p - 20) * 4;    // 16-20 => 10 CHF + 21-30 => +4/kg
  return 0;
}

/* =========================
   PRIX
========================= */
function recalculer(){
  const service = document.getElementById("service").value;
  if(!service || !km || km <= 0) return;

  let ht = PRIX_BASE[service] + km * MULTI_KM[service];

  colis.forEach((c,i)=>{
    ht += surchargePoids(c.poids);
    if(i > 0) ht += SUPPL_COLIS;
  });

  const tva = ht * TVA;
  const ttc = ht + tva;

  document.getElementById("prix_ht").innerText = ht.toFixed(2);
  document.getElementById("prix_tva").innerText = tva.toFixed(2);
  document.getElementById("prix_ttc").innerText = ttc.toFixed(2);
}

/* =========================
   ENVOI + POPUP + RESET
========================= */
function envoyerFormulaire(){
  const service = document.getElementById("service").value;
  if(!km || km <= 0){ alert("Veuillez calculer la distance."); return false; }
  if(!service){ alert("Veuillez choisir un type de livraison."); return false; }

  // Remplit hidden
  document.getElementById("f_depart").value = adresse("pc");
  document.getElementById("f_arrivee").value = adresse("lv");
  document.getElementById("f_km").value = km.toFixed(1);
  document.getElementById("f_duree").value = String(duree);
  document.getElementById("f_prix_ht").value = document.getElementById("prix_ht").innerText;
  document.getElementById("f_prix_tva").value = document.getElementById("prix_tva").innerText;
  document.getElementById("f_prix_ttc").value = document.getElementById("prix_ttc").innerText;
  document.getElementById("f_colis_json").value = JSON.stringify(colis);

  // POST Apps Script
  const data = new FormData(document.getElementById("formDemande"));

  fetch("TON_SCRIPT_GOOGLE", { method:"POST", body:data })
    .catch(()=>{}); // on ignore l'erreur c√¥t√© client

  // popup
  const popup = document.getElementById("popup");
  popup.style.display = "block";

  // reset
  document.getElementById("formDemande").reset();
  document.getElementById("distance_txt").innerText = "‚Äì";
  document.getElementById("duree_txt").innerText = "‚Äì";
  document.getElementById("prix_ht").innerText = "‚Äì";
  document.getElementById("prix_tva").innerText = "‚Äì";
  document.getElementById("prix_ttc").innerText = "‚Äì";
  km = 0; duree = 0;
  colis = [];
  ajouterColis();

  setTimeout(()=>{ popup.style.display = "none"; }, 5000);
  return false;
}

/* init 1 colis */
ajouterColis();
</script>

</body>
</html>
