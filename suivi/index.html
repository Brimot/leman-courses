<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estimation ‚Äì L√©man Courses</title>

<style>
:root{
  --blue:#16324f;
  --bg:#eef2f6;
  --card:#ffffff;
  --line:#dbe2ea;
  --eco:#2ecc71;
  --exp:#f39c12;
  --urg:#e74c3c;
  --muted:#6b7a89;
}

body{font-family:Arial,sans-serif;background:var(--bg);padding:30px;margin:0;}
.container{max-width:960px;margin:0 auto;}
.card{background:var(--card);border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.15);padding:26px;}
.header{text-align:center;margin-bottom:18px;}
.header h2{margin:0;color:var(--blue);}
.header p{margin:6px 0 0;color:var(--muted);}

.block{
  border:2px solid var(--line);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  background:#f9fbfd;
}
.block h3{margin:0 0 10px;color:var(--blue);font-size:16px;}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
@media(max-width:820px){.grid2,.grid3{grid-template-columns:1fr;}}

input,button,select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #cfd6de;
  font-size:15px;
  box-sizing:border-box;
}

.btn{
  border:none;
  color:white;
  font-weight:700;
  cursor:pointer;
  transition: .15s ease;
}
.btn:active{transform:scale(.98);}
.btn.selected{outline:3px solid rgba(0,0,0,.18); box-shadow:0 0 0 3px rgba(0,0,0,.10) inset;}
.btn-main{background:var(--blue);}
.btn-eco{background:var(--eco);}
.btn-exp{background:var(--exp);}
.btn-urg{background:var(--urg);}
.btn-light{background:#fff;color:var(--blue);border:1px solid var(--line);font-weight:700;}

.small{font-size:13px;color:var(--muted);margin-top:6px;}
.ok{color:#1e9b52;font-weight:700;margin-top:8px;}
.warn{color:#c0392b;font-weight:700;margin-top:8px;}

.badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
.badge{background:var(--blue);color:white;padding:10px 14px;border-radius:999px;font-weight:700;}

.prices{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px;}
@media(max-width:820px){.prices{grid-template-columns:1fr;}}
.priceCard{border:2px solid var(--line);border-radius:14px;padding:12px;background:white;text-align:center;}
.priceCard .label{color:var(--muted);font-size:13px;}
.priceCard .val{font-size:22px;font-weight:800;color:var(--blue);margin-top:6px;}
.divider{height:1px;background:var(--line);margin:14px 0;}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h2>üöö Estimation L√©man Courses</h2>
      <p>Devis instantan√© ¬∑ VIP auto ¬∑ Poids max 30kg/colis</p>
    </div>

    <!-- CLIENT -->
    <div class="block">
      <h3>üë§ Client</h3>
      <div class="grid3">
        <input id="client" placeholder="Nom / Entreprise" />
        <input id="tel" placeholder="T√©l√©phone" />
        <input id="email" placeholder="Email" />
      </div>
      <div class="small">Ces infos servent uniquement √† l‚Äôenvoi de la demande par email.</div>
    </div>

    <!-- PRISE EN CHARGE -->
    <div class="block">
      <h3>üìç Prise en charge</h3>
      <div class="grid2">
        <input id="pc_npa" placeholder="Code postal" />
        <input id="pc_ville" placeholder="Ville" />
      </div>
      <div class="grid2" style="margin-top:10px;">
        <input id="pc_rue" placeholder="Rue (optionnel)" />
        <input id="pc_no" placeholder="N¬∞ (optionnel)" />
      </div>
    </div>

    <!-- LIVRAISON -->
    <div class="block">
      <h3>üèÅ Livraison</h3>
      <div class="grid2">
        <input id="lv_npa" placeholder="Code postal" />
        <input id="lv_ville" placeholder="Ville" />
      </div>
      <div class="grid2" style="margin-top:10px;">
        <input id="lv_rue" placeholder="Rue (optionnel)" />
        <input id="lv_no" placeholder="N¬∞ (optionnel)" />
      </div>
    </div>

    <!-- SERVICE -->
    <div class="block">
      <h3>‚ö° Service</h3>
      <div class="grid3">
        <button type="button" class="btn btn-eco" id="btnEco" onclick="setService('eco', this)">Eco</button>
        <button type="button" class="btn btn-exp" id="btnExp" onclick="setService('express', this)">Express</button>
        <button type="button" class="btn btn-urg" id="btnUrg" onclick="setService('urgent', this)">Urgent</button>
      </div>
      <input type="hidden" id="service" />
      <div id="service_msg" class="ok" style="display:none;"></div>
    </div>

    <!-- COLIS -->
    <div class="block">
      <h3>üì¶ Colis</h3>
      <div class="grid3">
        <button type="button" class="btn btn-light" onclick="retirerColis()">‚ûñ Retirer</button>
        <button type="button" class="btn btn-light" onclick="ajouterColis()">‚ûï Ajouter</button>
        <div class="badge" style="text-align:center;">Nb : <span id="colis_txt">1</span>/5</div>
      </div>

      <div id="colis_zone" style="margin-top:10px;"></div>

      <div class="small">Max 30 kg par colis. Le poids total est calcul√© automatiquement.</div>
      <div class="ok">Poids total : <span id="poids_total_txt">0</span> kg</div>
    </div>

    <!-- VIP -->
    <div class="block">
      <h3>‚≠ê VIP</h3>
      <div class="grid2">
        <input id="vip_code" placeholder="Code VIP" />
        <button type="button" class="btn btn-main" onclick="recalculer()">Calculer</button>
      </div>
      <div id="vip_status" class="small"></div>
      <div class="small">Le recalcul se fait automatiquement quand tu tapes le code.</div>
    </div>

    <!-- RESULTATS -->
    <div class="badges">
      <div class="badge">Distance : <span id="km">‚Äì</span> km</div>
      <div class="badge">Dur√©e : <span id="duree">‚Äì</span> min</div>
    </div>

    <div class="prices">
      <div class="priceCard">
        <div class="label">HT</div>
        <div class="val">CHF <span id="ht">‚Äì</span></div>
      </div>
      <div class="priceCard">
        <div class="label">TVA</div>
        <div class="val">CHF <span id="tva">‚Äì</span></div>
      </div>
      <div class="priceCard">
        <div class="label">TTC</div>
        <div class="val">CHF <span id="ttc">‚Äì</span></div>
      </div>
    </div>

    <div class="divider"></div>

    <button type="button" class="btn btn-main" onclick="envoyerMail()">üì© Envoyer la demande par email</button>
    <div id="mail_msg" class="ok" style="display:none;"></div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9Fj76QqvdNqDY2tk_1bd-W5wmDd0AYcQTDTiW9e8Iz-K7XQ1QXhS-CeGdymu78Mtk/exec";

let colis = 1;
let selectedBtn = null;

function setService(val, btn){
  document.getElementById("service").value = val;

  // visuel s√©lection
  document.querySelectorAll("#btnEco,#btnExp,#btnUrg").forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedBtn = btn;

  const msg = document.getElementById("service_msg");
  msg.style.display = "block";
  msg.textContent = "Service s√©lectionn√© : " + val.toUpperCase();

  recalculer();
}

function adresse(prefix){
  const npa = document.getElementById(prefix+"_npa").value.trim();
  const ville = document.getElementById(prefix+"_ville").value.trim();
  const rue = document.getElementById(prefix+"_rue").value.trim();
  const no = document.getElementById(prefix+"_no").value.trim();

  if(!npa || !ville) return "";

  let a = "";
  if(rue) a += rue;
  if(no) a += (a ? " " : "") + no;
  a += (a ? ", " : "") + npa + " " + ville + ", Suisse";
  return a;
}

function renderColis(){
  const zone = document.getElementById("colis_zone");
  zone.innerHTML = "";

  for(let i=1;i<=colis;i++){
    zone.innerHTML += `
      <input type="number" min="1" max="30"
        placeholder="Poids colis ${i} (kg) ‚Äì max 30"
        class="poids_colis">
    `;
  }

  // bind input recalcul
  zone.querySelectorAll(".poids_colis").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      // bloque >30
      const v = Number(inp.value)||0;
      if(v > 30){
        inp.value = 30;
      }
      recalculer();
    });
  });

  document.getElementById("colis_txt").textContent = colis;
  poidsTotal(); // refresh
}

function ajouterColis(){
  if(colis >= 5){
    alert("Maximum 5 colis");
    return;
  }
  colis++;
  renderColis();
  recalculer();
}

function retirerColis(){
  if(colis <= 1){
    alert("Minimum 1 colis");
    return;
  }
  colis--;
  renderColis();
  recalculer();
}

function poidsTotal(){
  let total = 0;
  document.querySelectorAll(".poids_colis").forEach(el=>{
    total += Number(el.value)||0;
  });
  document.getElementById("poids_total_txt").textContent = total;
  return total;
}

// VIP recalcul auto
document.getElementById("vip_code").addEventListener("input", ()=>{
  recalculer();
});

function recalculer(){
  const from = adresse("pc");
  const to = adresse("lv");
  const service = document.getElementById("service").value;
  const vip = document.getElementById("vip_code").value.trim();
  const poids = poidsTotal();

  if(!from || !to || !service){
    return; // pas assez d'infos
  }

  const url = SCRIPT_URL
    + "?action=quote"
    + "&from=" + encodeURIComponent(from)
    + "&to=" + encodeURIComponent(to)
    + "&service=" + encodeURIComponent(service)
    + "&colis=" + encodeURIComponent(colis)
    + "&poids=" + encodeURIComponent(poids)
    + "&vip=" + encodeURIComponent(vip);

  fetch(url)
    .then(r=>r.json())
    .then(res=>{
      if(res.error){
        alert(res.error);
        return;
      }
      document.getElementById("km").textContent = res.km;
      document.getElementById("duree").textContent = res.duree;
      document.getElementById("ht").textContent = res.ht;
      document.getElementById("tva").textContent = res.tva;
      document.getElementById("ttc").textContent = res.ttc;

      const vs = document.getElementById("vip_status");
      if(vip){
        vs.className = res.vip_ok ? "ok" : "warn";
        vs.textContent = res.vip_ok
          ? "‚úÖ VIP accept√© ‚Äî coef poids appliqu√© (" + res.coef_poids + ")"
          : "‚ö†Ô∏è Code VIP invalide ‚Äî tarif standard";
      }else{
        vs.className = "small";
        vs.textContent = "";
      }
    })
    .catch(()=>{
      alert("Erreur de connexion au serveur");
    });
}

function envoyerMail(){
  const from = adresse("pc");
  const to = adresse("lv");
  const service = document.getElementById("service").value;
  const vip = document.getElementById("vip_code").value.trim();

  if(!from || !to || !service){
    alert("Veuillez compl√©ter prise en charge, livraison et service.");
    return;
  }

  const data = new FormData();
  data.append("client", document.getElementById("client").value.trim());
  data.append("tel", document.getElementById("tel").value.trim());
  data.append("email", document.getElementById("email").value.trim());
  data.append("depart", from);
  data.append("arrivee", to);
  data.append("service", service);
  data.append("vip", vip);
  data.append("colis", String(colis));
  data.append("poids", document.getElementById("poids_total_txt").textContent);
  data.append("km", document.getElementById("km").textContent);
  data.append("duree", document.getElementById("duree").textContent);
  data.append("ht", document.getElementById("ht").textContent);
  data.append("tva", document.getElementById("tva").textContent);
  data.append("ttc", document.getElementById("ttc").textContent);

  fetch(SCRIPT_URL, { method:"POST", body:data })
    .then(()=>{
      const m = document.getElementById("mail_msg");
      m.style.display = "block";
      m.textContent = "‚úÖ Demande envoy√©e par email.";
    })
    .catch(()=>{
      alert("Erreur lors de l'envoi email");
    });
}

window.onload = renderColis;
</script>
</body>
</html>
