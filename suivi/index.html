<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>LÃ©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#eef2f6;padding:30px}
.card{max-width:800px;margin:auto;background:white;padding:25px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
h2{text-align:center;color:#16324f}
input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
.btn{background:#16324f;color:white;font-weight:bold}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{background:#16324f;color:white;padding:8px 16px;border-radius:20px}
</style>
</head>

<body>
<div class="card">
<h2>ðŸšš LÃ©man Courses</h2>

<div class="row">
  <input id="pc_npa" placeholder="NPA dÃ©part">
  <input id="pc_ville" placeholder="Ville dÃ©part">
</div>

<div class="row">
  <input id="lv_npa" placeholder="NPA arrivÃ©e">
  <input id="lv_ville" placeholder="Ville arrivÃ©e">
</div>

<select id="service" onchange="recalculer()">
  <option value="">Service</option>
  <option value="eco">Eco</option>
  <option value="express">Express</option>
  <option value="urgent">Urgent</option>
</select>

<div>
  Colis : <span id="colis_txt">1</span>
  <button onclick="ajouterColis()">+</button>
  <button onclick="retirerColis()">-</button>
</div>

<div id="colis_zone"></div>
<div>Poids total : <b><span id="poids_total_txt">0</span> kg</b></div>

<input id="vip_code" placeholder="Code VIP" oninput="recalculer()">

<button class="btn" onclick="recalculer()">Calculer</button>

<div class="row">
  <div class="badge">Distance: <span id="km">â€“</span> km</div>
  <div class="badge">DurÃ©e: <span id="duree">â€“</span> min</div>
</div>

<p>
HT: CHF <span id="ht">â€“</span><br>
TVA: CHF <span id="tva">â€“</span><br>
TTC: CHF <span id="ttc">â€“</span>
</p>

<button class="btn" onclick="envoyerMail()">Envoyer par mail</button>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/TON_ID/exec";
let colis = 1;

function adresse(p){
  return document.getElementById(p+"_npa").value+" "+
         document.getElementById(p+"_ville").value+", Suisse";
}

function renderColis(){
  colis_zone.innerHTML="";
  for(let i=1;i<=colis;i++){
    colis_zone.innerHTML += `
      <input type="number" min="1" max="30"
        placeholder="Poids colis ${i} (kg)"
        class="poids_colis"
        oninput="recalculer()">
    `;
  }
}

function poidsTotal(){
  let total=0;
  document.querySelectorAll(".poids_colis").forEach(el=>{
    total += Number(el.value)||0;
  });
  poids_total_txt.innerText = total;
  return total;
}

function ajouterColis(){
  if(colis<5) colis++;
  colis_txt.innerText=colis;
  renderColis();
  recalculer();
}
function retirerColis(){
  if(colis>1) colis--;
  colis_txt.innerText=colis;
  renderColis();
  recalculer();
}

function recalculer(){
  const from=adresse("pc");
  const to=adresse("lv");
  const s=service.value;
  const vip=vip_code.value.trim();
  const poids=poidsTotal();

  if(!from||!to||!s) return;

  fetch(SCRIPT_URL+"?action=quote"
    +"&from="+encodeURIComponent(from)
    +"&to="+encodeURIComponent(to)
    +"&service="+s
    +"&colis="+colis
    +"&poids="+poids
    +"&vip="+vip)
  .then(r=>r.json())
  .then(res=>{
    if(res.error){ alert(res.error); return; }
    km.innerText=res.km;
    duree.innerText=res.duree;
    ht.innerText=res.ht;
    tva.innerText=res.tva;
    ttc.innerText=res.ttc;
  });
}

function envoyerMail(){
  const data=new FormData();
  data.append("depart", adresse("pc"));
  data.append("arrivee", adresse("lv"));
  data.append("km", km.innerText);
  data.append("duree", duree.innerText);
  data.append("service", service.value);
  data.append("vip", vip_code.value);
  data.append("colis", colis);
  data.append("poids", poids_total_txt.innerText);
  data.append("ht", ht.innerText);
  data.append("tva", tva.innerText);
  data.append("ttc", ttc.innerText);

  fetch(SCRIPT_URL,{method:"POST",body:data})
    .then(()=>alert("Demande envoyÃ©e"));
}

window.onload = renderColis;
</script>
</body>
</html>
