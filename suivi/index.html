<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Estimation ‚Äì L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0; padding:30px;
}
.card{
  max-width:900px; margin:auto;
  background:#fff; padding:25px;
  border-radius:16px;
  box-shadow:0 8px 25px rgba(0,0,0,.15);
}
h2{text-align:center;color:#1f3b57;margin:0}
.sub{text-align:center;color:#555;margin:6px 0 20px}

input,select,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  background:#1f3b57;
  color:white;
  font-weight:bold;
  border:none;
  cursor:pointer;
}
button:hover{opacity:.9}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media(max-width:800px){
  .grid-2,.grid-3{grid-template-columns:1fr}
}

.section{margin-top:18px}
.label{font-weight:bold;color:#1f3b57}

.badges{display:flex;justify-content:center;gap:15px;margin-top:15px}
.badge{background:#1f3b57;color:white;padding:8px 14px;border-radius:999px}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f0f3f7}

.pricegrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center;margin-top:15px}
.big{font-size:22px;font-weight:bold}

#popup{
  display:none;
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  text-align:center;
  z-index:9999;
}
</style>
</head>

<body>

<form id="formDemande" onsubmit="return envoyerFormulaire()">
<div class="card">

<h2>üöö Estimation L√©man Courses</h2>
<div class="sub">Calcul automatique ¬∑ TVA 8.1% ¬∑ Max 30 kg/colis</div>

<div class="section">
<div class="label">Coordonn√©es</div>
<div class="grid-3">
  <input name="client" placeholder="Nom / Entreprise" required>
  <input name="tel" placeholder="T√©l√©phone">
  <input name="email" placeholder="E-mail" required>
</div>
</div>

<div class="section">
<div class="label">Prise en charge</div>
<div class="grid-2">
  <input id="pc_rue" placeholder="Rue">
  <input id="pc_no" placeholder="N¬∞">
  <input id="pc_npa" placeholder="NPA">
  <input id="pc_ville" placeholder="Ville">
</div>
</div>

<div class="section">
<div class="label">Livraison</div>
<div class="grid-2">
  <input id="lv_rue" placeholder="Rue">
  <input id="lv_no" placeholder="N¬∞">
  <input id="lv_npa" placeholder="NPA">
  <input id="lv_ville" placeholder="Ville">
</div>
</div>

<button type="button" onclick="calculerDistance()">Calculer distance</button>

<div class="badges">
  <div class="badge">Distance: <span id="distance_txt">‚Äì</span> km</div>
  <div class="badge">Dur√©e: <span id="duree_txt">‚Äì</span> min</div>
</div>

<div class="section">
<div class="label">Type de livraison</div>
<select id="service" onchange="recalculer()">
  <option value="">Choisir</option>
  <option value="eco">Eco 24h</option>
  <option value="express">Express 12h</option>
  <option value="urgent">Urgent 4h</option>
</select>
</div>

<div class="section">
<div class="label">Code client (optionnel)</div>
<input id="code_client" placeholder="Ex: VIP2026">
</div>

<div class="section">
<div class="label">Colis</div>
<table>
<thead>
<tr><th>#</th><th>Poids kg</th><th>Action</th></tr>
</thead>
<tbody id="colis_table"></tbody>
</table>
<button type="button" onclick="ajouterColis()">‚ûï Ajouter colis</button>
</div>

<div class="section">
<div class="label">Prix</div>
<div class="pricegrid">
  <div>HT<br><span class="big">CHF <span id="prix_ht">‚Äì</span></span></div>
  <div>TVA<br><span class="big">CHF <span id="prix_tva">‚Äì</span></span></div>
  <div><strong>TTC</strong><br><span class="big">CHF <span id="prix_ttc">‚Äì</span></span></div>
</div>
</div>

<input type="hidden" name="depart" id="f_depart">
<input type="hidden" name="arrivee" id="f_arrivee">
<input type="hidden" name="km" id="f_km">
<input type="hidden" name="duree" id="f_duree">
<input type="hidden" name="prix_ht" id="f_prix_ht">
<input type="hidden" name="prix_tva" id="f_prix_tva">
<input type="hidden" name="prix_ttc" id="f_prix_ttc">
<input type="hidden" name="colis_json" id="f_colis_json">

<button type="submit">Envoyer</button>

</div>
</form>

<div id="popup">‚úÖ Demande envoy√©e</div>

<script>
let km=0, duree=0;
let colis=[];

const TVA=0.081;
const PRIX_BASE={eco:12.5,express:17.5,urgent:22.5};
const MULTI_KM={eco:0.5,express:0.6,urgent:0.7};
const SUPPL_COLIS=5;

function adresse(p){
  return document.getElementById(p+"_rue").value+" "+
         document.getElementById(p+"_no").value+", "+
         document.getElementById(p+"_npa").value+" "+
         document.getElementById(p+"_ville").value+", Suisse";
}

function calculerDistance(){
  const o = adresse("pc");
  const d = adresse("lv");

  if(!o || !d){
    alert("Adresse incompl√®te");
    return;
  }

  fetch(
    "https://script.google.com/macros/s/AKfycbyAFs9mMCC7bC1-8w0H1OBVZyBuKScjY0Rbfdxun8tWZ1Fn5kQsILYQlviclTzSWRVL/exec"
    + "?action=distance"
    + "&origin=" + encodeURIComponent(o)
    + "&dest=" + encodeURIComponent(d)
  )
  .then(r => r.json())
  .then(res => {

    if(res.error){
      alert("Erreur distance : " + res.error);
      return;
    }

    km = parseFloat(res.km);
    duree = parseInt(res.duree);

    if(isNaN(km) || isNaN(duree)){
      alert("Distance non calculable");
      return;
    }

    document.getElementById("distance_txt").innerText = km.toFixed(1);
    document.getElementById("duree_txt").innerText = duree;

    recalculer();
  })
  .catch(err=>{
    alert("Erreur r√©seau");
    console.error(err);
  });
}


function ajouterColis(){
  colis.push({id:Date.now(),poids:1});
  renderColis();
  recalculer();
}

function supprimerColis(id){
  colis=colis.filter(c=>c.id!==id);
  renderColis(); recalculer();
}

function renderColis(){
  colis_table.innerHTML="";
  colis.forEach((c,i)=>{
    colis_table.innerHTML+=`
<tr>
<td>${i+1}</td>
<td><input type="number" value="${c.poids}" min="1" max="30"
 oninput="c.poids=this.value;recalculer()"></td>
<td>${i?`<button onclick="supprimerColis(${c.id})">‚ùå</button>`:"‚Äî"}</td>
</tr>`;
  });
}

function surchargePoids(p){
  if(p<=15) return 0;
  if(p<=20) return (p-15)*2;
  if(p<=30) return 10+(p-20)*4;
  return 0;
}

function recalculer(){
  const s=service.value;
  if(!s||!km) return;

  let ht=PRIX_BASE[s]+km*MULTI_KM[s];
  colis.forEach((c,i)=>{
    ht+=surchargePoids(c.poids);
    if(i>0) ht+=SUPPL_COLIS;
  });

  if(code_client.value==="VIP2026") ht*=0.8;

  prix_ht.innerText=ht.toFixed(2);
  prix_tva.innerText=(ht*TVA).toFixed(2);
  prix_ttc.innerText=(ht*(1+TVA)).toFixed(2);
}

function envoyerFormulaire(){
  f_depart.value=adresse("pc");
  f_arrivee.value=adresse("lv");
  f_km.value=km;
  f_duree.value=duree;
  f_prix_ht.value=prix_ht.innerText;
  f_prix_tva.value=prix_tva.innerText;
  f_prix_ttc.value=prix_ttc.innerText;
  f_colis_json.value=JSON.stringify(colis);

  fetch("https://script.google.com/macros/s/AKfycbyAFs9mMCC7bC1-8w0H1OBVZyBuKScjY0Rbfdxun8tWZ1Fn5kQsILYQlviclTzSWRVL/exec",
  {method:"POST",body:new FormData(formDemande)});

  popup.style.display="block";
  formDemande.reset();
  colis=[]; ajouterColis();
  setTimeout(()=>popup.style.display="none",4000);
  return false;
}

window.onload=()=>ajouterColis();
</script>
</body>
</html>
