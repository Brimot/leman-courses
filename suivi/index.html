<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  font-family:Arial;
  background:#0B2A44;
  padding:40px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#fff;
  padding:30px;
  border-radius:14px;
}
input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:10px;
}
button{
  width:100%;
  background:#FDB913;
  border:none;
  padding:14px;
  font-weight:bold;
  border-radius:10px;
  cursor:pointer;
}
#result{
  margin-top:20px;
}
#mapModal{
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
}
#mapBox{
  background:#fff;
  width:90%;
  max-width:600px;
  height:80%;
  margin:5% auto;
  padding:10px;
  border-radius:10px;
}
#map{width:100%;height:100%;}
</style>
</head>

<body>

<div class="card">
  <h2>üì¶ Suivi L√©man Courses</h2>
  <input id="code" placeholder="LC-001">
  <button onclick="track()">Suivre mon colis</button>

  <div id="result"></div>
  <button id="mapBtn" style="display:none" onclick="openMap()">Voir la carte</button>
</div>

<div id="mapModal" onclick="closeMap()">
  <div id="mapBox" onclick="event.stopPropagation()">
    <div id="map"></div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbz1JimDNK9DfaLOUjup5d6e4W5DdZnQyTx6qF6XsBe7ENa-l--HP6Ssz3gsKrL6gYRL/exec";

let dataGlobal,map;

async function track(){
  const code=document.getElementById("code").value.trim();
  const resDiv=document.getElementById("result");
  resDiv.innerHTML="‚è≥ Recherche...";
  
  const r=await fetch(API+"?code="+encodeURIComponent(code));
  const d=await r.json();
  
  if(d.error){
    resDiv.innerHTML="‚ùå "+d.error;
    return;
  }
  
  dataGlobal=d;
  document.getElementById("mapBtn").style.display="block";

  resDiv.innerHTML=`
  <b>Statut:</b> ${d.statut}<br>
  <b>√âtape:</b> ${d.etape}<br>
  <b>Client:</b> ${d.client.nom}<br><br>

  üìç <b>Prise en charge</b><br>
  ${d.prise.adresse}, ${d.prise.npa} ${d.prise.ville}<br>

  üì¶ <b>Livraison</b><br>
  ${d.livraison.adresse}, ${d.livraison.npa} ${d.livraison.ville}
  `;
}

function openMap(){
  document.getElementById("mapModal").style.display="block";

  if(!map){
    map=L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    fetch("https://nominatim.openstreetmap.org/search?format=json&q="+
      dataGlobal.prise.adresse+" "+dataGlobal.prise.ville)
    .then(r=>r.json()).then(p=>{
      fetch("https://nominatim.openstreetmap.org/search?format=json&q="+
        dataGlobal.livraison.adresse+" "+dataGlobal.livraison.ville)
      .then(r=>r.json()).then(l=>{
        const A=[p[0].lat,p[0].lon];
        const B=[l[0].lat,l[0].lon];
        map.setView(A,9);
        L.marker(A).addTo(map).bindPopup("Prise en charge");
        L.marker(B).addTo(map).bindPopup("Livraison");
        L.polyline([A,B],{color:"blue"}).addTo(map);
      });
    });
  }
}

function closeMap(){
  document.getElementById("mapModal").style.display="none";
}
</script>

</body>
</html>
