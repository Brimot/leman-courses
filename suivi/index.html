<script>
let kmReels = 0;
let map;
let directionsService;
let directionsRenderer;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 46.8, lng: 8.3 }, // Suisse
    zoom: 7,
    disableDefaultUI: true,
    zoomControl: true
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    map: map,
    suppressMarkers: false
  });
}

function calculerDistance() {
  const depart = document.getElementById("depart").value;
  const arrivee = document.getElementById("arrivee").value;

  if (!depart || !arrivee) {
    alert("Merci de renseigner les deux adresses");
    return;
  }

  directionsService.route(
    {
      origin: depart,
      destination: arrivee,
      travelMode: google.maps.TravelMode.DRIVING
    },
    function (result, status) {
      if (status === "OK") {
        directionsRenderer.setDirections(result);

        const distanceMetres =
          result.routes[0].legs[0].distance.value;

        kmReels = distanceMetres / 1000;

        document.getElementById("distance").innerText =
          kmReels.toFixed(1);

        calculerPrix();
      } else {
        alert("Impossible de calculer l’itinéraire");
      }
    }
  );
}

function calculerPrix() {
  let prix = 25;
  let poids = parseFloat(document.getElementById("poids").value) || 0;
  let urgence = parseFloat(document.getElementById("urgence").value);
  let nuit = document.getElementById("nuit").checked;
  let ue = document.getElementById("ue").checked;

  prix += kmReels * 2.20;
  prix += urgence;

  if (poids > 5 && poids <= 20) prix += 10;
  if (poids > 20) prix += 20;

  if (ue) prix += 40;
  if (nuit) prix *= 1.25;

  if (prix < 25) prix = 25;

  document.getElementById("prix").innerText = prix.toFixed(2);
}

function envoyerWhatsApp() {
  const msg =
    `Bonjour,%0AJe souhaite une course Léman-Courses.%0A%0A` +
    `Départ : ${depart.value}%0A` +
    `Arrivée : ${arrivee.value}%0A` +
    `Distance : ${kmReels.toFixed(1)} km%0A` +
    `Prix estimé : CHF ${prix.innerText}`;

  window.open(`https://wa.me/41798700488?text=${msg}`, "_blank");
}

function envoyerEmail() {
  const sujet = "Demande de course – Léman-Courses";
  const corps =
    `Départ : ${depart.value}\n` +
    `Arrivée : ${arrivee.value}\n` +
    `Distance : ${kmReels.toFixed(1)} km\n` +
    `Prix estimé : CHF ${prix.innerText}`;

  window.location.href =
    `mailto:info@leman-courses.ch?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(corps)}`;
}

window.onload = initMap;
</script>
