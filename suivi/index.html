<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi L√©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
    font-family:Arial;
    background:#0B2A44;
    padding:40px;
}
.card{
    max-width:600px;
    margin:auto;
    background:white;
    padding:25px;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.3);
}
h2{text-align:center;color:#0B2A44;}
input{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-top:10px;
}
button{
    width:100%;
    margin-top:15px;
    padding:14px;
    background:#FFB913;
    border:none;
    font-weight:bold;
    border-radius:10px;
    cursor:pointer;
}
#res{
    margin-top:20px;
    line-height:1.6;
}
.badge{
    background:#0B2A44;
    color:white;
    padding:6px 10px;
    border-radius:8px;
    display:inline-block;
}
#mapBtn{
    display:none;
    margin-top:15px;
}
#mapPopup{
    display:none;
    position:fixed;
    inset:0;
    background:#000000cc;
    z-index:9999;
}
#mapHeader{
    background:white;
    padding:14px;
    font-weight:bold;
    cursor:pointer;
}
#map{
    width:100%;
    height:calc(100% - 50px);
}
</style>
</head>

<body>
<div class="card">
    <h2>üì¶ Suivi L√©man Courses</h2>
    <input id="code" placeholder="Ex : LC-001">
    <button onclick="suivre()">Suivre mon colis</button>

    <div id="res"></div>

    <button id="mapBtn" onclick="openMap()">üó∫Ô∏è Voir le trajet</button>
</div>

<div id="mapPopup">
    <div id="mapHeader" onclick="closeMap()">‚Üê Retour</div>
    <div id="map"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw8327wSkRWjKLy6D-UcI2qHq4GIPoDEaH6BCXuaMFVTa7A8daVCGTnTCIXcgxI2GZR/exec";
let dataGlobal, map, route;

async function suivre(){
    const code = document.getElementById("code").value.trim();
    const res = document.getElementById("res");
    res.innerHTML="‚è≥ Recherche...";
    document.getElementById("mapBtn").style.display="none";

    try{
        const r = await fetch(API+"?code="+encodeURIComponent(code));
        const d = await r.json();

        if(d.error){
            res.innerHTML="‚ùå "+d.error;
            return;
        }

        dataGlobal = d;

        res.innerHTML = `
        <span class="badge">${d.statut}</span><br><br>

        <b>√âtape :</b> ${d.etape}<br>
        <b>Derni√®re mise √† jour :</b> ${new Date(d.date).toLocaleString()}<br>
        <b>Commentaire :</b> ${d.commentaire || "-"}<br><br>

        <b>Client</b><br>
        ${d.client.nom}<br>
        üìû ${d.client.tel}<br>
        ‚úâÔ∏è ${d.client.email}<br><br>

        <b>Prise en charge</b><br>
        ${d.prise.adresse}<br>
        ${d.prise.npa} ${d.prise.ville}<br>
        üïí ${new Date(d.prise.heure).toLocaleString()}<br><br>

        <b>Livraison</b><br>
        ${d.livraison.adresse}<br>
        ${d.livraison.npa} ${d.livraison.ville}<br>
        üïí ${new Date(d.livraison.heure).toLocaleString()}
        `;

        if(d.prise.lat && d.livraison.lat){
            document.getElementById("mapBtn").style.display="block";
        }

    }catch(e){
        res.innerHTML="‚ö†Ô∏è Erreur de connexion au service";
    }
}

function openMap(){
    document.getElementById("mapPopup").style.display="block";

    setTimeout(()=>{
        if(!map){
            map = L.map("map");
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        }
        if(route) map.removeLayer(route);

        const a=[dataGlobal.prise.lat,dataGlobal.prise.lng];
        const b=[dataGlobal.livraison.lat,dataGlobal.livraison.lng];

        L.marker(a).addTo(map).bindPopup("Prise en charge");
        L.marker(b).addTo(map).bindPopup("Livraison");

        route = L.polyline([a,b],{color:"red"}).addTo(map);
        map.fitBounds(route.getBounds(),{padding:[40,40]});
    },200);
}

function closeMap(){
    document.getElementById("mapPopup").style.display="none";
}
</script>

</body>
</html>
