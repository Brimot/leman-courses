<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Estimation â€“ LÃ©man Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#0B2A44,#123B5A);
    margin:0; padding:30px;
  }
  .card{
    max-width:980px; margin:auto;
    background:#fff; padding:25px;
    border-radius:18px;
    box-shadow:0 15px 40px rgba(0,0,0,.3);
  }
  h2{ text-align:center; color:#0B2A44; margin:0; }
  .sub{ text-align:center; color:#38556e; margin:6px 0 18px; }

  input, select, button{
    width:100%;
    padding:12px;
    margin-top:8px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    box-sizing:border-box;
  }
  button{
    background:#FDB913;
    font-weight:bold;
    border:none;
    cursor:pointer;
  }
  button:hover{ opacity:.92; }

  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  @media(max-width:820px){
    .grid-2,.grid-3{ grid-template-columns:1fr; }
  }

  .section{ margin-top:18px; }
  .label{ font-weight:bold; color:#0B2A44; margin-bottom:6px; }

  .badges{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .badge{
    background:#0B2A44;
    color:#fff;
    padding:8px 14px;
    border-radius:999px;
    font-size:14px;
  }

  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border:1px solid #ddd; padding:8px; text-align:center; }
  th{ background:#f5f7fa; color:#0B2A44; }

  .smallbtn{
    background:#e6eef8;
    border:1px solid #cfd9e6;
    border-radius:10px;
    padding:10px;
    cursor:pointer;
    font-weight:bold;
  }

  .pricegrid{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
    text-align:center;
    margin-top:14px;
  }
  @media(max-width:820px){ .pricegrid{ grid-template-columns:1fr; } }
  .big{ font-size:22px; font-weight:bold; }

  .note{ font-size:12px; color:#567; text-align:center; margin-top:10px; }

  #popup{
    display:none;
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:white;
    padding:22px 26px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
    text-align:center;
    z-index:9999;
  }

  .whatsapp{
    position:fixed;
    bottom:20px;
    right:20px;
    background:#25D366;
    color:#fff;
    padding:14px 18px;
    border-radius:999px;
    font-weight:bold;
    text-decoration:none;
    box-shadow:0 6px 14px rgba(0,0,0,.3);
    z-index:9999;
  }
</style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBf_najf7fv02LK85xZ1uKAV6ZI3Z-rhoo"></script>
</head>


<body>

<form id="formDemande" onsubmit="return envoyerFormulaire();">
  <div class="card">

    <h2>ğŸšš Estimation LÃ©man Courses</h2>
    <div class="sub">Distance calculÃ©e via Google Â· TVA 8.1% Â· Max 30 kg/colis</div>

    <div class="section">
      <div class="label">ğŸ‘¤ CoordonnÃ©es</div>
      <div class="grid-3">
        <input name="client" id="client" placeholder="Nom / Entreprise" required>
        <input name="tel" id="tel" placeholder="TÃ©lÃ©phone">
        <input name="email" id="email" placeholder="E-mail" required>
      </div>
    </div>

    <div class="section">
      <div class="label">ğŸ“ Prise en charge</div>
      <div class="grid-2">
        <input id="pc_rue" placeholder="Rue">
        <input id="pc_no" placeholder="NÂ°">
        <input id="pc_npa" placeholder="NPA">
        <input id="pc_ville" placeholder="Ville">
      </div>
    </div>

    <div class="section">
      <div class="label">ğŸšš Livraison</div>
      <div class="grid-2">
        <input id="lv_rue" placeholder="Rue">
        <input id="lv_no" placeholder="NÂ°">
        <input id="lv_npa" placeholder="NPA">
        <input id="lv_ville" placeholder="Ville">
      </div>
    </div>

    <button type="button" onclick="calculerDistance()">ğŸ“ Calculer la distance</button>

    <div class="badges">
      <div class="badge">Distance: <strong><span id="distance_txt">â€“</span> km</strong></div>
      <div class="badge">DurÃ©e: <strong><span id="duree_txt">â€“</span> min</strong></div>
    </div>

    <div class="section">
      <div class="label">ğŸš€ Type de livraison</div>
      <select id="service" name="service" onchange="recalculer()">
        <option value="">â€” Choisir â€”</option>
        <option value="eco">Eco 24h</option>
        <option value="express">Express 12h</option>
        <option value="urgent">Urgent 4h</option>
      </select>
    </div>

    <div class="section">
      <div class="label">ğŸ“¦ Colis (max 5)</div>
      <table>
        <thead>
          <tr><th>#</th><th>Poids (kg)</th><th>Type</th><th>Action</th></tr>
        </thead>
        <tbody id="colis_table"></tbody>
      </table>
      <button class="smallbtn" type="button" onclick="ajouterColis()">â• Ajouter un colis</button>
      <div class="note">16â€“20 kg: +2 CHF/kg Â· 21â€“30 kg: +4 CHF/kg Â· +5 CHF dÃ¨s le 2e colis</div>
    </div>

    <div class="section">
      <div class="label">ğŸ’° Prix</div>
      <div class="pricegrid">
        <div>HT<br><span class="big">CHF <span id="prix_ht">â€“</span></span></div>
        <div>TVA<br><span class="big">CHF <span id="prix_tva">â€“</span></span></div>
        <div><strong>TTC</strong><br><span class="big">CHF <span id="prix_ttc">â€“</span></span></div>
      </div>
    </div>

    <input type="hidden" name="depart" id="f_depart">
    <input type="hidden" name="arrivee" id="f_arrivee">
    <input type="hidden" name="km" id="f_km">
    <input type="hidden" name="duree" id="f_duree">
    <input type="hidden" name="prix_ht" id="f_prix_ht">
    <input type="hidden" name="prix_tva" id="f_prix_tva">
    <input type="hidden" name="prix_ttc" id="f_prix_ttc">
    <input type="hidden" name="colis_json" id="f_colis_json">

    <button type="submit">ğŸ“¨ Envoyer la demande</button>

  </div>
</form>

<div id="popup">âœ… Demande envoyÃ©e avec succÃ¨s !</div>

<a class="whatsapp"
   href="https://script.google.com/macros/s/AKfycbxREhP0WJ5rUy5hfvjfO8hK6_-6AQrQdk1xGHzwTzza_tCormjGMcagcVG048DL-2q-/exec"
   target="_blank">ğŸ’¬ Aide WhatsApp</a>

<script>
/* ===== VARIABLES ===== */
let km = 0;
let duree = 0;
let colis = [];

/* ===== PRIX ===== */
const TVA = 0.081;
const PRIX_BASE = { eco:25, express:35, urgent:45 };
const MULTI_KM  = { eco:1, express:1.2, urgent:1.4 };
const SUPPL_COLIS = 5;
const MAX_COLIS  = 5;

/* ===== BOUTON CALCUL DISTANCE ===== */
function calculerDistance(){
  const origin = adresse("pc");
  const dest   = adresse("lv");

  if(!origin || !dest){
    alert("Veuillez remplir les adresses !");
    return;
  }

  fetch("https://script.google.com/macros/s/AKfycbxREhP0WJ5rUy5hfvjfO8hK6_-6AQrQdk1xGHzwTzza_tCormjGMcagcVG048DL-2q-/exec"
    + "?action=distance"
    + "&origin=" + encodeURIComponent(origin)
    + "&dest="  + encodeURIComponent(dest)
  )
  .then(r => r.json())
  .then(data => {
    if(data.error){
      alert(data.error);
      return;
    }
    km    = Number(data.km)    || 0;
    duree = Number(data.duree) || 0;

    document.getElementById("distance_txt").innerText = km.toFixed(1);
    document.getElementById("duree_txt").innerText   = duree;

    recalculer();
  })
  .catch(()=>alert("Erreur distance"));
}

/* ===== ADRESSE ===== */
function adresse(p){
  return document.getElementById(p+"_rue").value + " "
       + document.getElementById(p+"_no").value  + ", "
       + document.getElementById(p+"_npa").value + " "
       + document.getElementById(p+"_ville").value;
}

/* ===== COLIS ===== */
function ajouterColis(){
  if(colis.length >= MAX_COLIS){ alert("Max 5"); return; }
  colis.push({id:Date.now(), poids:1, type:"Standard"});
  renderColis();
  recalculer();
}

function supprimerColis(id){
  colis = colis.filter(c=>c.id!==id);
  renderColis();
  recalculer();
}

function renderColis(){
  const tb = document.getElementById("colis_table");
  tb.innerHTML = "";
  colis.forEach((c,i)=>{
    tb.innerHTML += `
<tr>
  <td>${i+1}</td>
  <td><input type="number" min="1" max="30" value="${c.poids}"
     oninput="c.poids=this.value;recalculer()"></td>
  <td>
    <select onchange="c.type=this.value">
      <option>Standard</option>
      <option>MÃ©dical</option>
      <option>Fragile</option>
      <option>Alimentaire</option>
      <option>Documents</option>
      <option>Autre</option>
    </select>
  </td>
  <td>${i?`<button onclick="supprimerColis(${c.id})">âŒ</button>`:"â€”"}</td>
</tr>`;
  });
}

/* ===== SURCHARGE ===== */
function surchargePoids(p){
  p = Number(p)||0;
  if(p<=15) return 0;
  if(p<=20) return (p-15)*2;
  return 10+(p-20)*4;
}

/* ===== PRIX ===== */
function recalculer(){
  const s = document.getElementById("service").value;
  if(!s || !km) return;
  let ht = PRIX_BASE[s] + km * MULTI_KM[s];
  colis.forEach((c,i)=>{ ht += surchargePoids(c.poids); if(i>0) ht += SUPPL_COLIS; });
  const tva = ht*TVA;
  document.getElementById("prix_ht").innerText = ht.toFixed(2);
  document.getElementById("prix_tva").innerText = tva.toFixed(2);
  document.getElementById("prix_ttc").innerText = (ht+tva).toFixed(2);
}

/* ===== ENVOI ===== */
function envoyerFormulaire(){
  if(!km){ alert("Calcule la distance dâ€™abord"); return false; }

  // 1. Remplir les champs cachÃ©s
  document.getElementById("f_depart").value = adresse("pc");
  document.getElementById("f_arrivee").value = adresse("lv");
  document.getElementById("f_km").value = km.toFixed(1);
  document.getElementById("f_duree").value = String(duree);
  document.getElementById("f_prix_ht").value = document.getElementById("prix_ht").innerText;
  document.getElementById("f_prix_tva").value = document.getElementById("prix_tva").innerText;
  document.getElementById("f_prix_ttc").value = document.getElementById("prix_ttc").innerText;
  document.getElementById("f_colis_json").value = JSON.stringify(colis);

  // 2. PUIS crÃ©er le FormData
  const form = document.getElementById("formDemande");
  const data = new FormData(form);

  // 3. Envoi
  fetch("https://script.google.com/macros/s/AKfycbwBip8qzm0ZzbKotaIGGD-KV7U6eNUA3pHsZx_T4YjL8PuIte1Mn3LmxrbMLBbY7DhR/exec", {
    method:"POST",
    body:data
  });

  // 4. UI
  document.getElementById("popup").style.display="block";
  form.reset();
  colis=[]; ajouterColis();
  setTimeout(()=>document.getElementById("popup").style.display="none",5000);
  return false;
}


/* init */
ajouterColis();

</script>

</body>
</html>
