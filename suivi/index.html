<script>
let map, ds, dr, km=0, duree=0;
let colis=[];

/* CONFIG PRIX */
const TVA = 0.081;
const PRIX_BASE = { eco:25, express:35, urgent:45 };
const MULTI_KM = { eco:1.0, express:1.2, urgent:1.4 };
const SUPPL_COLIS = 5;

/* MAP */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:46.8,lng:8.3}, zoom:7
  });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({map});
}

/* AUTO VILLE */
function autoVilleGoogle(npa, id){
  if(!/^\d{4}$/.test(npa)) return;
  new google.maps.Geocoder().geocode(
    { address:npa, componentRestrictions:{country:"CH"} },
    (res,status)=>{
      if(status==="OK"){
        res[0].address_components.forEach(c=>{
          if(c.types.includes("locality")){
            document.getElementById(id).value = c.long_name;
          }
        });
      }
    }
  );
}

/* ADRESSE */
function adresse(p){
  return document.getElementById(p+"_npa").value+" "+
         document.getElementById(p+"_ville").value;
}

/* DISTANCE */
function calculerDistance(){
  ds.route({
    origin: adresse("pc"),
    destination: adresse("lv"),
    travelMode:"DRIVING"
  },(r,s)=>{
    if(s==="OK"){
      dr.setDirections(r);
      km = r.routes[0].legs[0].distance.value/1000;
      duree = Math.ceil(r.routes[0].legs[0].duration.value/60);
      distance_txt.innerText = km.toFixed(1);
      duree_txt.innerText = duree;
      recalculer();
    }
  });
}

/* COLIS */
function ajouterColis(){
  if(colis.length>=5){ alert("Max 5 colis"); return; }
  colis.push({id:Date.now(), poids:1});
  renderColis();
  recalculer();
}

function supprimerColis(id){
  colis = colis.filter(c=>c.id!==id);
  renderColis();
  recalculer();
}

function renderColis(){
  colis_table.innerHTML="";
  colis.forEach((c,i)=>{
    colis_table.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>
<input type="number" min="1" max="30" value="${c.poids}"
oninput="c.poids=this.value;recalculer()">
</td>
<td>${i?`<button onclick="supprimerColis(${c.id})">❌</button>`:"—"}</td>
</tr>`;
  });
}

/* SURCHARGE POIDS */
function surchargePoids(p){
  if(p<=15) return 0;
  if(p<=20) return (p-15)*2;
  if(p<=30) return 10+(p-20)*4;
  return 0;
}

/* PRIX */
function recalculer(){
  const service = serviceEl.value;
  if(!km || !service) return;

  let ht = PRIX_BASE[service] + km*MULTI_KM[service];

  colis.forEach((c,i)=>{
    ht += surchargePoids(c.poids);
    if(i>0) ht += SUPPL_COLIS;
  });

  let tva = ht*TVA;
  prix_ht.innerText = ht.toFixed(2);
  prix_tva.innerText = tva.toFixed(2);
  prix_ttc.innerText = (ht+tva).toFixed(2);
}

/* ENVOI */
function envoyerFormulaire(){
  const data = new FormData(formDemande);

  fetch("https://script.google.com/macros/s/TON_SCRIPT/exec",{
    method:"POST",
    body:data
  });

  popup.style.display="block";
  formDemande.reset();
  colis=[];
  ajouterColis();
  setTimeout(()=>popup.style.display="none",5000);
  return false;
}

const serviceEl = document.getElementById("service");
ajouterColis();
</script>
