<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Estimation ‚Äì L√©man Courses</title>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#17324d;
    --muted:#5b6b7a;
    --line:#e6eaf0;
    --btn:#2a4b7c;
    --btn2:#eef3fb;
    --badge:#ecf2ff;
    --ok:#1f9d55;
  }
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    margin:0;
    padding:24px;
    color:var(--text);
  }
  .card{
    max-width:980px;
    margin:auto;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 10px 30px rgba(10,20,30,.08);
    padding:22px;
  }
  h1{
    margin:0;
    font-size:22px;
    text-align:center;
    letter-spacing:.2px;
  }
  .sub{
    text-align:center;
    margin:6px 0 16px;
    color:var(--muted);
    font-size:13px;
  }
  .section{ margin-top:14px; }
  .label{ font-weight:700; margin-bottom:6px; }

  input, select, button{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    font-size:15px;
    box-sizing:border-box;
    outline:none;
    background:#fff;
  }
  input:focus, select:focus{
    border-color:#b8c7e6;
    box-shadow:0 0 0 3px rgba(42,75,124,.10);
  }

  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  @media(max-width:860px){ .grid-2,.grid-3{ grid-template-columns:1fr; } }

  .btn{
    background:var(--btn);
    color:#fff;
    border:none;
    font-weight:800;
    cursor:pointer;
  }
  .btn:hover{ opacity:.95; }
  .btn-soft{
    background:var(--btn2);
    border:1px solid #d7e3ff;
    color:var(--btn);
    font-weight:800;
    cursor:pointer;
  }

  .badges{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
    justify-content:center;
  }
  .badge{
    background:var(--badge);
    border:1px solid #d7e3ff;
    padding:8px 12px;
    border-radius:999px;
    font-size:14px;
  }

  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border:1px solid var(--line); padding:8px; text-align:center; }
  th{ background:#f8fafc; color:var(--text); }

  .pricegrid{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
    margin-top:12px;
    text-align:center;
  }
  @media(max-width:860px){ .pricegrid{ grid-template-columns:1fr; } }
  .big{ font-size:22px; font-weight:900; }

  .note{
    margin-top:8px;
    color:var(--muted);
    font-size:12px;
    text-align:center;
  }

  #popup{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    z-index:9999;
    align-items:center;
    justify-content:center;
  }
  #popup .box{
    background:#fff;
    padding:18px 18px;
    border-radius:14px;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    text-align:center;
    max-width:360px;
    width:92%;
  }
  #popup .ok{
    color:var(--ok);
    font-weight:900;
    font-size:16px;
  }
  .whatsapp{
    position:fixed;
    right:18px;
    bottom:18px;
    background:#25D366;
    color:#fff;
    text-decoration:none;
    padding:12px 14px;
    border-radius:999px;
    font-weight:900;
    box-shadow:0 10px 20px rgba(0,0,0,.15);
  }
</style>
</head>

<body>

<div class="card">
  <h1>üöö Estimation L√©man Courses</h1>
  <div class="sub">Distance via votre script ¬∑ TVA 8.1% ¬∑ Max 30 kg/colis</div>

  <form id="formDemande">
    <div class="section">
      <div class="label">üë§ Coordonn√©es</div>
      <div class="grid-3">
        <input name="client" id="client" placeholder="Nom / Entreprise" required>
        <input name="tel" id="tel" placeholder="T√©l√©phone">
        <input name="email" id="email" placeholder="E-mail" required>
      </div>
    </div>

    <div class="section">
      <div class="label">üìç Prise en charge</div>
      <div class="grid-2">
        <input id="pc_rue" placeholder="Rue">
        <input id="pc_no" placeholder="N¬∞">
        <input id="pc_npa" placeholder="NPA (optionnel)">
        <input id="pc_ville" placeholder="Ville" required>
      </div>
    </div>

    <div class="section">
      <div class="label">üöö Livraison</div>
      <div class="grid-2">
        <input id="lv_rue" placeholder="Rue">
        <input id="lv_no" placeholder="N¬∞">
        <input id="lv_npa" placeholder="NPA (optionnel)">
        <input id="lv_ville" placeholder="Ville" required>
      </div>
    </div>

    <button class="btn" type="button" id="btnDistance">Calculer distance</button>

    <div class="badges">
      <div class="badge">Distance : <strong><span id="distance_txt">‚Äì</span> km</strong></div>
      <div class="badge">Dur√©e : <strong><span id="duree_txt">‚Äì</span> min</strong></div>
    </div>

    <div class="section">
      <div class="label">üöÄ Type de livraison</div>
      <select id="service" name="service" required>
        <option value="">‚Äî Choisir ‚Äî</option>
        <option value="eco">Eco 24h</option>
        <option value="express">Express 12h</option>
        <option value="urgent">Urgent 4h</option>
      </select>
    </div>

    <div class="section">
      <div class="label">üè∑Ô∏è Code client (tarif n√©goci√©)</div>
      <input id="code_client" name="code_client" placeholder="Ex : VIP2026">
    </div>

    <div class="section">
      <div class="label">üì¶ Colis (max 5)</div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Poids (kg)</th>
            <th>Contenu</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="colis_table"></tbody>
      </table>
      <button class="btn-soft" type="button" id="btnAddColis">‚ûï Ajouter un colis</button>
      <div class="note">16‚Äì20 kg: +2 CHF/kg ¬∑ 21‚Äì30 kg: +4 CHF/kg ¬∑ +5 CHF d√®s le 2e colis</div>
    </div>

    <div class="section">
      <div class="label">üí∞ Prix</div>
      <div class="pricegrid">
        <div>HT<br><span class="big">CHF <span id="prix_ht">‚Äì</span></span></div>
        <div>TVA<br><span class="big">CHF <span id="prix_tva">‚Äì</span></span></div>
        <div><strong>TTC</strong><br><span class="big"><strong>CHF <span id="prix_ttc">‚Äì</span></strong></span></div>
      </div>
    </div>

    <!-- Hidden fields envoy√©s au script -->
    <input type="hidden" name="depart" id="f_depart">
    <input type="hidden" name="arrivee" id="f_arrivee">
    <input type="hidden" name="km" id="f_km">
    <input type="hidden" name="duree" id="f_duree">
    <input type="hidden" name="prix_ht" id="f_prix_ht">
    <input type="hidden" name="prix_tva" id="f_prix_tva">
    <input type="hidden" name="prix_ttc" id="f_prix_ttc">
    <input type="hidden" name="colis_json" id="f_colis_json">

    <button class="btn" type="submit" style="margin-top:14px;">Envoyer la demande</button>
  </form>
</div>

<div id="popup">
  <div class="box">
    <div class="ok">‚úÖ Demande envoy√©e</div>
    <div style="margin-top:6px;color:#3a4a5a;">Merci, on vous recontacte rapidement.</div>
  </div>
</div>

<!-- WhatsApp (tu peux mettre ton vrai lien wa.me) -->
<a class="whatsapp" href="https://wa.me/41798700488" target="_blank">üí¨ Aide WhatsApp</a>

<script>
/* =========================
   CONFIG
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxREhP0WJ5rUy5hfvjfO8hK6_-6AQrQdk1xGHzwTzza_tCormjGMcagcVG048DL-2q-/exec";

/* =========================
   STATE
========================= */
let km = 0;
let duree = 0;
let colis = [];

/* PRIX (r√©duits 50% comme demand√©) */
const TVA = 0.081;
const PRIX_BASE = { eco: 12.5, express: 17.5, urgent: 22.5 };
const MULTI_KM  = { eco: 0.5,  express: 0.6,  urgent: 0.7  };
const SUPPL_COLIS = 5;
const MAX_COLIS = 5;

/* Codes client (exemple) */
const CODES_REMISE = {
  "VIP2026": 0.80,   // -20%
  "PARTNER": 0.85    // -15%
};

/* =========================
   HELPERS DOM
========================= */
const $ = (id)=>document.getElementById(id);

/* =========================
   ADRESSE
========================= */
function adresse(prefix){
  const rue   = $(prefix+"_rue").value.trim();
  const no    = $(prefix+"_no").value.trim();
  const npa   = $(prefix+"_npa").value.trim();
  const ville = $(prefix+"_ville").value.trim();

  // minimum ville
  if(!ville) return "";

  const partRue = [rue, no].join(" ").trim();
  const partLoc = [npa, ville].join(" ").trim();

  return [partRue, partLoc, "Suisse"].filter(Boolean).join(", ").replace(/\s+/g," ").trim();
}

/* =========================
   DISTANCE
========================= */
async function calculerDistance(){
  const origin = adresse("pc");
  const dest   = adresse("lv");

  if(!origin || !dest){
    alert("Merci de renseigner au minimum les villes (d√©part et arriv√©e).");
    return;
  }

  const url = SCRIPT_URL + "?action=distance"
    + "&origin=" + encodeURIComponent(origin)
    + "&dest="   + encodeURIComponent(dest);

  try{
    const r = await fetch(url, { method:"GET" });
    const res = await r.json();

    if(res.error){
      alert("Erreur distance : " + res.error);
      return;
    }

    const k = Number(res.km);
    const d = Number(res.duree);

    if(!isFinite(k) || !isFinite(d)){
      alert("Distance non calculable (valeurs invalides).");
      return;
    }

    km = k;
    duree = d;

    $("distance_txt").innerText = km.toFixed(1);
    $("duree_txt").innerText = String(duree);

    recalculer();

  }catch(e){
    console.error(e);
    alert("Erreur r√©seau lors du calcul de distance.");
  }
}

/* =========================
   COLIS
========================= */
function ajouterColis(){
  if(colis.length >= MAX_COLIS){
    alert("Maximum 5 colis.");
    return;
  }
  colis.push({
    id: Date.now() + Math.floor(Math.random()*1000),
    poids: 1,
    type: "Standard"
  });
  renderColis();
  recalculer();
}

function supprimerColis(id){
  colis = colis.filter(c => c.id !== id);
  renderColis();
  recalculer();
}

function majColis(id, champ, val){
  const c = colis.find(x => x.id === id);
  if(!c) return;

  if(champ === "poids"){
    let p = Number(val);
    if(!isFinite(p)) p = 1;
    if(p < 1) p = 1;
    if(p > 30) p = 30;
    c.poids = p;
  } else if(champ === "type"){
    c.type = String(val || "Standard");
  }

  recalculer();
}

function renderColis(){
  const tb = $("colis_table");
  tb.innerHTML = "";

  colis.forEach((c,i)=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${i+1}</td>
        <td>
          <input type="number" min="1" max="30" value="${c.poids}"
            oninput="majColis(${c.id},'poids',this.value)">
        </td>
        <td>
          <select onchange="majColis(${c.id},'type',this.value)">
            ${["Standard","Documents","M√©dical","Fragile","Alimentaire","Autre"].map(t =>
              `<option ${c.type===t?"selected":""}>${t}</option>`
            ).join("")}
          </select>
        </td>
        <td>
          ${i===0 ? "‚Äî" : `<button type="button" class="btn-soft" onclick="supprimerColis(${c.id})">‚ùå</button>`}
        </td>
      </tr>
    `);
  });
}

/* =========================
   SURCHARGES POIDS
========================= */
function surchargePoids(p){
  p = Number(p) || 0;
  if(p <= 15) return 0;
  if(p <= 20) return (p - 15) * 2;
  if(p <= 30) return (5 * 2) + (p - 20) * 4;
  return 0;
}

/* =========================
   PRIX
========================= */
function recalculer(){
  const service = $("service").value;
  if(!service || !km) return;

  let ht = PRIX_BASE[service] + km * MULTI_KM[service];

  colis.forEach((c,i)=>{
    ht += surchargePoids(c.poids);
    if(i>0) ht += SUPPL_COLIS;
  });

  const code = $("code_client").value.trim().toUpperCase();
  if(code && CODES_REMISE[code]){
    ht *= CODES_REMISE[code];
  }

  const tva = ht * TVA;
  const ttc = ht + tva;

  $("prix_ht").innerText = ht.toFixed(2);
  $("prix_tva").innerText = tva.toFixed(2);
  $("prix_ttc").innerText = ttc.toFixed(2);
}

/* =========================
   ENVOI FORMULAIRE
========================= */
async function envoyerFormulaire(e){
  e.preventDefault();

  if(!km){
    alert("Calcule d‚Äôabord la distance.");
    return false;
  }
  const service = $("service").value;
  if(!service){
    alert("Choisis un type de livraison.");
    return false;
  }

  // Hidden fields
  $("f_depart").value = adresse("pc");
  $("f_arrivee").value = adresse("lv");
  $("f_km").value = km.toFixed(1);
  $("f_duree").value = String(duree);
  $("f_prix_ht").value = $("prix_ht").innerText;
  $("f_prix_tva").value = $("prix_tva").innerText;
  $("f_prix_ttc").value = $("prix_ttc").innerText;
  $("f_colis_json").value = JSON.stringify(colis);

  // Ajoute aussi code_client dans le form (d√©j√† name="code_client" donc OK)
  const form = $("formDemande");
  const data = new FormData(form);

  try{
    await fetch(SCRIPT_URL, { method:"POST", body:data });
  }catch(err){
    // m√™me si √ßa plante c√¥t√© r√©seau, on garde l'exp√©rience client OK
    console.warn("POST error", err);
  }

  // Popup + reset
  $("popup").style.display = "flex";
  form.reset();
  $("distance_txt").innerText = "‚Äì";
  $("duree_txt").innerText = "‚Äì";
  $("prix_ht").innerText = "‚Äì";
  $("prix_tva").innerText = "‚Äì";
  $("prix_ttc").innerText = "‚Äì";

  km = 0; duree = 0;
  colis = [];
  ajouterColis();

  setTimeout(()=>{ $("popup").style.display="none"; }, 4000);
  return false;
}

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  $("btnDistance").addEventListener("click", calculerDistance);
  $("btnAddColis").addEventListener("click", ajouterColis);
  $("service").addEventListener("change", recalculer);
  $("code_client").addEventListener("input", recalculer);
  $("formDemande").addEventListener("submit", envoyerFormulaire);

  ajouterColis(); // 1er colis
});
</script>

</body>
</html>
