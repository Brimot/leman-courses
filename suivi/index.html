<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calcul de course</title>
<style>
body{font-family:Arial;background:#f5f7fa;padding:30px}
.card{max-width:800px;margin:auto;background:white;padding:25px;border-radius:12px}
input,select,button{width:100%;padding:10px;margin-top:8px}
button{background:#1f3b57;color:white;border:none}
.badge{display:inline-block;background:#1f3b57;color:white;padding:6px 12px;border-radius:20px;margin:5px}
</style>
</head>

<body>
<form id="formDemande" onsubmit="return envoyer()">
<div class="card">

<h2>Calcul Léman-Courses</h2>

<input name="client" placeholder="Nom" required>
<input name="email" placeholder="Email" required>
<input name="tel" placeholder="Téléphone">

<h3>Départ</h3>
<input id="pc_npa" placeholder="NPA" oninput="ville(this.value,'pc_ville')">
<input id="pc_ville" placeholder="Ville">

<h3>Arrivée</h3>
<input id="lv_npa" placeholder="NPA" oninput="ville(this.value,'lv_ville')">
<input id="lv_ville" placeholder="Ville">

<button type="button" onclick="distance()">Calculer distance</button>

<div>
<span class="badge">Distance: <span id="distance_txt">–</span> km</span>
<span class="badge">Durée: <span id="duree_txt">–</span> min</span>
</div>

<select id="service" name="service" onchange="prix()">
<option value="">Type</option>
<option value="eco">Eco</option>
<option value="express">Express</option>
<option value="urgent">Urgent</option>
</select>

<input id="code_client" name="code_client" placeholder="Code client">

<h3>Colis</h3>
<table id="colis_table"></table>
<button type="button" onclick="ajouterColis()">Ajouter colis</button>

<h3>Prix</h3>
HT: <span id="prix_ht">–</span><br>
TVA: <span id="prix_tva">–</span><br>
TTC: <span id="prix_ttc">–</span>

<input type="hidden" name="depart" id="f_depart">
<input type="hidden" name="arrivee" id="f_arrivee">
<input type="hidden" name="km" id="f_km">
<input type="hidden" name="duree" id="f_duree">
<input type="hidden" name="prix_ht" id="f_prix_ht">
<input type="hidden" name="prix_tva" id="f_prix_tva">
<input type="hidden" name="prix_ttc" id="f_prix_ttc">
<input type="hidden" name="colis_json" id="f_colis_json">

<button type="submit">Envoyer</button>
</div>
</form>

<script>
const API="https://script.google.com/macros/s/AKfycbwwYwk87pBV0JHBqu7Q2dvhbPharMum7hU6z5JDc7WVMrB-MbtwsoepRboLkbA5XK0N/exec";
let km=0,duree=0,colis=[];

function ville(npa,id){
 if(npa.length!=4) return;
 fetch(API+"?action=ville&npa="+npa)
 .then(r=>r.json()).then(d=>document.getElementById(id).value=d.ville);
}

function distance(){
 const o=pc_npa.value+" "+pc_ville.value;
 const d=lv_npa.value+" "+lv_ville.value;
 fetch(API+"?action=distance&origin="+encodeURIComponent(o)+"&dest="+encodeURIComponent(d))
 .then(r=>r.json()).then(res=>{
   km=parseFloat(res.km);
   duree=parseInt(res.duree);
   distance_txt.innerText=km;
   duree_txt.innerText=duree;
   prix();
 });
}

function ajouterColis(){
 colis.push({poids:1});
 render();
}

function render(){
 colis_table.innerHTML="";
 colis.forEach((c,i)=>{
 colis_table.innerHTML+=`<tr>
<td>#${i+1}</td>
<td><input type="number" value="${c.poids}" 
oninput="colis[${i}].poids=this.value;prix()"></td>
<td><button onclick="colis.splice(${i},1);render()">❌</button></td>
</tr>`;
 });
}

function prix(){
 if(!km||!service.value) return;
 let base={eco:12.5,express:17.5,urgent:22.5};
 let mult={eco:0.5,express:0.6,urgent:0.7};
 let ht=base[service.value]+km*mult[service.value];
 if(code_client.value==="VIP2026") ht*=0.8;
 prix_ht.innerText=ht.toFixed(2);
 prix_tva.innerText=(ht*0.081).toFixed(2);
 prix_ttc.innerText=(ht*1.081).toFixed(2);
}

function envoyer(){
 f_depart.value=pc_npa.value+" "+pc_ville.value;
 f_arrivee.value=lv_npa.value+" "+lv_ville.value;
 f_km.value=km;
 f_duree.value=duree;
 f_prix_ht.value=prix_ht.innerText;
 f_prix_tva.value=prix_tva.innerText;
 f_prix_ttc.value=prix_ttc.innerText;
 f_colis_json.value=JSON.stringify(colis);
 fetch(API,{method:"POST",body:new FormData(formDemande)});
 alert("Envoyé");
 return false;
}

ajouterColis();
</script>
</body>
</html>
